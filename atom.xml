<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>串一串</title>
  
  <subtitle>断舍离</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://chuanyichuan.github.io/"/>
  <updated>2021-10-20T16:59:32.448Z</updated>
  <id>http://chuanyichuan.github.io/</id>
  
  <author>
    <name>cc</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>业务架构图应该怎么画</title>
    <link href="http://chuanyichuan.github.io/2021/10/21/%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%9B%BE%E5%BA%94%E8%AF%A5%E6%80%8E%E4%B9%88%E7%94%BB/"/>
    <id>http://chuanyichuan.github.io/2021/10/21/业务架构图应该怎么画/</id>
    <published>2021-10-20T16:00:00.000Z</published>
    <updated>2021-10-20T16:59:32.448Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h3><p>业务架构图是一种表达业务层级和关系的工具。</p><ol><li>业务架构图需要表达业务之间的层级和关系，帮你梳理业务系统</li><li>将复杂业务的逻辑简单化，降低理解难度</li><li>给用户及相关人员查看</li></ol><p>业务架构服务于业务目标，通过描绘业务上下层关系，梳理一整套完整、简单的业务视图，降低业务系统的复杂度，提高用户理解度，最终给用户最直观的业务体现。</p><h3 id="业务架构类型"><a class="markdownIt-Anchor" href="#业务架构类型"></a> 业务架构类型</h3><h4 id="上中下结构"><a class="markdownIt-Anchor" href="#上中下结构"></a> 上中下结构</h4><p>由下向上分为：资源层、数据层、平台层、业务层、用户层</p><h4 id="左中右结构"><a class="markdownIt-Anchor" href="#左中右结构"></a> 左中右结构</h4><p>由左向右分为：上游产业、业务模型、下游产业</p><h3 id="奥义"><a class="markdownIt-Anchor" href="#奥义"></a> 奥义</h3><blockquote><p>画业务架构图实际上就是对业务的一种收集、提炼、拆解、归纳和分类的一个过程。</p><p>可以分为三个步骤：分层、分模块、分功能</p></blockquote><h4 id="分层"><a class="markdownIt-Anchor" href="#分层"></a> 分层</h4><p>分层是指将业务按照层级区分，每个层级都属于是一个独立的板块。比如按照IaaS、PaaS、SaaS分层。</p><p>按照<strong>下层更抽象，上层更具体</strong>的原则，将业务架构图理解为一棵树的结构。</p><p>层级需要有逻辑上的关联，比如下层为上层服务，或者下层为上层提供能力支撑。比如数据层为平台层提供数据支撑，平台层为业务层提供基础能力和数据分析的能力，通过SDK为业务层提供服务，减少业务层的重复开发。</p><h4 id="分模块"><a class="markdownIt-Anchor" href="#分模块"></a> 分模块</h4><p>分模块是指在同一个层级中，拆解出有哪些独立的模块，每一个模块都可以代表是一个完整的产品，或者是同类型的业务聚合。</p><p>每一个模块之间都是独立的，模块之间也可以存在相互依赖、相互关联的关系。比如平台层中可以有基础服务平台、开放平台、应用平台等，三个平台之间不存在相互依赖和关联的关系，属于独立存在的平行关系；又比如在应用层有引擎应用、调度应用、配置应用、平台服务应用，这四个模块之间存在平台服务依赖于配置、调度和引擎，引擎应用依赖于调度和配置，所以他们之间存在相互依赖和关联关系。</p><h4 id="分功能"><a class="markdownIt-Anchor" href="#分功能"></a> 分功能</h4><p>分功能是指在一个模块中，将独立的功能划分出来，每一个功能都代表是一个业务入口。简单点讲就是将一个模块体系中比较具有代表性的、且用户最关注的业务功能给提炼出来。比如应用层可以划分核心应用、基础应用、职能应用、第三方应用等模块，然后再将每个模块的重要功能填充进去，这样一个模块就划分完整了。</p><h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3><p>在画业务架构图前，必须先对整个业务体系进行全量的思考，将所有涉及到的应用、功能、系统、能力和平台全部都要罗列出来，然后再进行提炼、归纳、分类，按照常用的分类模板或自建模板进行大体框架构思，最后按照分层、分模块、分功能的维度将具体内容补充进去。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;前言&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#前言&quot;&gt;&lt;/a&gt; 前言&lt;/h3&gt;
&lt;p&gt;业务架构图是一种表达业务层级和关系的工具。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;业务架构图需要表达业务之间的层级和关系，帮你梳理业务系统&lt;/li&gt;
&lt;li
      
    
    </summary>
    
    
      <category term="架构设计" scheme="http://chuanyichuan.github.io/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="架构图" scheme="http://chuanyichuan.github.io/tags/%E6%9E%B6%E6%9E%84%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>效能是什么</title>
    <link href="http://chuanyichuan.github.io/2021/09/15/%E6%95%88%E8%83%BD%E6%98%AF%E4%BB%80%E4%B9%88/"/>
    <id>http://chuanyichuan.github.io/2021/09/15/效能是什么/</id>
    <published>2021-09-15T15:00:00.000Z</published>
    <updated>2021-09-22T15:22:49.634Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h3 id="一-效能是什么"><a class="markdownIt-Anchor" href="#一-效能是什么"></a> 一、效能是什么</h3><p>对于效能这个词，很多人应该都不陌生，它是指有效的、集体的效应，即在有目的、有组织的活动中所表现出来的效率和效果，它反映了所开展活动目标选择的正确性及其实现的程度。我们从这句话中抓住两个关键词：效率和效果，我们可以把效率简单的理解为<code>工作量/工作时间</code>，而效果就是<code>工作完成的质量</code>，所以从这个角度来解释效能的话，就是高效率且高质量的完成工作的能力。那么<code>研发效能</code>在现在理解起来就很简单了：提升研发效率，提高研发质量。所以对于研发效能这个方向来说，重点应该放在如何提升研发效能的同时还能保证研发质量。</p><h3 id="二-谈效能的意义"><a class="markdownIt-Anchor" href="#二-谈效能的意义"></a> 二、谈效能的意义</h3><p>效能的关键词是效率和质量，所以只能是围绕着人的能力去谈效能，通过效能数据的分析，对执行人的各项能力进行精准化的评估，最终依据评估结果做出对应的改善。</p><p>我们都知道短板效应，它同样适用于建设团队，每一个领导都希望拥有一支极具战斗力的团队，只有</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h3 id=&quot;一-效能是什么&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#一-效能是什么&quot;&gt;&lt;/a&gt; 一、效能是什么&lt;/h3&gt;
&lt;p&gt;对于效能这个词，很多人应该都不陌生，它是指有效的、集体的效应，即在有目的、有组织的活动中
      
    
    </summary>
    
    
      <category term="DevOps" scheme="http://chuanyichuan.github.io/categories/DevOps/"/>
    
    
      <category term="效能" scheme="http://chuanyichuan.github.io/tags/%E6%95%88%E8%83%BD/"/>
    
  </entry>
  
  <entry>
    <title>面向对象到底是什么</title>
    <link href="http://chuanyichuan.github.io/2021/08/19/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%88%B0%E5%BA%95%E6%98%AF%E4%BB%80%E4%B9%88/"/>
    <id>http://chuanyichuan.github.io/2021/08/19/面向对象到底是什么/</id>
    <published>2021-08-18T16:01:00.000Z</published>
    <updated>2021-08-23T01:31:38.423Z</updated>
    
    <content type="html"><![CDATA[<p>深夜小茶会上，突然蹦出一个想法：面向对象到底是什么？ 问题一经提出，全场安静，都是久经码场的Coder，竟然没有好好想过到底什么样才算是面向对象。</p><h5 id="到底什么是对象"><a class="markdownIt-Anchor" href="#到底什么是对象"></a> 到底什么是对象</h5><p>到底什么是对象呢？维基百科上这样写到：</p><blockquote><p>在计算机科学中，对象（英语：object），是一个存储器地址，其中拥有值，这个地址可能有标识符指向此处。对象可以是一个变量，一个数据结构，或是一个函数。是面向对象（Object Oriented）中的术语，既表示客观世界问题空间（Namespace）中的某个具体的事物，又表示软件系统解空间中的基本元素</p></blockquote><p>这句话说表示客观世界问题空间中某个具体的事物的基本元素我们称之为对象。那么我们是否可以理解为一个人就可以抽象为一个对象，一辆汽车也可以抽象为一个对象，世界万物皆对象。那么对象是有生命的吗？什么叫对象的生命？就拿人作为例子来讲，人有手脚嘴鼻眼，人可以自我完成很多行为，比如抓痒、说话、眨眼、呼吸…，正常人的情况下不需要借助外力就可完成这些行为，因为人是有生命的，相反如果没有生命的话，则任何事情都需要第三方的协助。那么我们创建的对象如果是没有生命的，那么就可以理解为仅仅就是一堆空架子，任何事情都需要借助别的对象来完成，这就违背了常规自然法则。</p><p>所以，我们所谓的对象，应该是具有生命力的一组元素的集合，也就是一棵树，由树根带动整棵树的生命力，树干、树叶、果实都依赖于树根提供养分，所以一棵树的所有元素聚合在一起就组成了树的对象实体，我们可以通过树根找到这棵树的所有元素，所以对于整个对象实体来说，根就成了这些聚合元素的聚合根，其他的元素就都成了对象实体的值对象。</p><h5 id="对象包括了什么"><a class="markdownIt-Anchor" href="#对象包括了什么"></a> 对象包括了什么</h5><p>依然先来看下</p><blockquote><p>在软件系统中，对象具有唯一的标识符，对象包括属性（Properties）和方法（Methods），属性就是需要记忆的信息，方法就是对象能够提供的服务。在面向对象（Object Oriented）的软件中，对象（Object）是某一个类（Class）的实例（Instance）。</p></blockquote><p>所有的对象都包括了属性和方法（行为），我们还从<code>People</code>开始看：属性包括了肤色、胳膊、腿、体重、年龄等，那么方法就有了获取和简单设置这些属性的方法，也就是我们最常见的setter/getter方法。从整个项目代码的层面俯视<code>People</code>类，发现这是一个完全独立于任何模块的类，可以单独进行单测和迁移。这个<code>People</code>类应该就是大多数Java程序员最常见到的一种，</p><h5 id="对象怎么定义"><a class="markdownIt-Anchor" href="#对象怎么定义"></a> 对象怎么定义</h5><h5 id="对象的含义是什么"><a class="markdownIt-Anchor" href="#对象的含义是什么"></a> 对象的含义是什么</h5><h5 id="对象里面有什么"><a class="markdownIt-Anchor" href="#对象里面有什么"></a> 对象里面有什么</h5><h5 id="对象外面又有什么"><a class="markdownIt-Anchor" href="#对象外面又有什么"></a> 对象外面又有什么</h5><h5 id="什么对象是独立的"><a class="markdownIt-Anchor" href="#什么对象是独立的"></a> 什么对象是独立的</h5><h5 id="什么对象又是只能被聚合的"><a class="markdownIt-Anchor" href="#什么对象又是只能被聚合的"></a> 什么对象又是只能被聚合的</h5><h5 id="对象的状态是什么"><a class="markdownIt-Anchor" href="#对象的状态是什么"></a> 对象的状态是什么</h5><h5 id="对象的行为是什么"><a class="markdownIt-Anchor" href="#对象的行为是什么"></a> 对象的行为是什么</h5><h5 id="对象的行为方式又是什么"><a class="markdownIt-Anchor" href="#对象的行为方式又是什么"></a> 对象的行为方式又是什么</h5><h5 id="面向对象编程到底是面向对象架构还是面向对象语言"><a class="markdownIt-Anchor" href="#面向对象编程到底是面向对象架构还是面向对象语言"></a> 面向对象编程到底是面向对象架构还是面向对象语言</h5>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;深夜小茶会上，突然蹦出一个想法：面向对象到底是什么？ 问题一经提出，全场安静，都是久经码场的Coder，竟然没有好好想过到底什么样才算是面向对象。&lt;/p&gt;
&lt;h5 id=&quot;到底什么是对象&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#到底什么是对
      
    
    </summary>
    
    
      <category term="杂谈" scheme="http://chuanyichuan.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    
  </entry>
  
  <entry>
    <title>服务器K8s部署脚本</title>
    <link href="http://chuanyichuan.github.io/2021/08/18/%E6%9C%8D%E5%8A%A1%E5%99%A8k8s%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC/"/>
    <id>http://chuanyichuan.github.io/2021/08/18/服务器k8s部署脚本/</id>
    <published>2021-08-18T08:31:00.000Z</published>
    <updated>2021-08-18T08:34:14.424Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">es-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">15</span><span class="string">Ti</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.17</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/elk/elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">es-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Ti</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">          image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/nfs-client-provisioner:latest</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line"><span class="attr">              value:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.17</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_PATH</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">/data/elk/elasticsearch</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">          nfs:</span></span><br><span class="line"><span class="attr">            server:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.17</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/data/elk/elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["events"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  archiveOnDelete:</span> <span class="string">"false"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">rest</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">inter-node</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">es</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span> </span><br><span class="line"><span class="attr">        app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">      schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line"><span class="attr">      initContainers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">increase-vm-max-map</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/busybox:latest</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["sysctl",</span> <span class="string">"-w"</span><span class="string">,</span> <span class="string">"vm.max_map_count=262144"</span><span class="string">]</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">increase-fd-ulimit</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/busybox:latest</span></span><br><span class="line"><span class="attr">        command:</span> <span class="string">["sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"ulimit -n 65536"</span><span class="string">]</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/elasticsearch_sa:7.6.2</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">rest</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">inter</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ca</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/elasticsearch/config/certs</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">cluster.name</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">k8s-logs</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">node.name</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">cluster.initial_master_nodes</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"es-0,es-1,es-2,es-3,es-4"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">discovery.zen.minimum_master_nodes</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">discovery.seed_hosts</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"elasticsearch"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"-Xms4096m -Xmx4096m"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">network.host</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ca</span></span><br><span class="line"><span class="attr">        secret:</span></span><br><span class="line"><span class="attr">          secretName:</span> <span class="string">quickstart-es-cert</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteMany"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">es-pv</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">1</span><span class="string">Ti</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kibana</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">5601</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kibana</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/kibana_zh:7.6.2</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_HOSTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="attr">http://elasticsearch:9200</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_USERNAME</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">elastic</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"sh_9527"</span> </span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">5601</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># filebeat</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">    - type:</span> <span class="string">container</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/var/log/containers/cicd*.log</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/var/log/containers/gerrittrigger*.log</span></span><br><span class="line"><span class="attr">      fields:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">k8s-cicd-log</span></span><br><span class="line"><span class="attr">      processors:</span></span><br><span class="line"><span class="attr">        - add_kubernetes_metadata:</span></span><br><span class="line"><span class="attr">            host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">            <span class="string">default_indexers.enabled:</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">default_matchers.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            matchers:</span></span><br><span class="line"><span class="attr">            - logs_path:</span></span><br><span class="line"><span class="attr">                logs_path:</span> <span class="string">"/var/log/containers/"</span></span><br><span class="line"><span class="attr">        - drop_fields:</span></span><br><span class="line"><span class="attr">            fields:</span> <span class="string">["host",</span> <span class="string">"tags"</span><span class="string">,</span> <span class="string">"ecs"</span><span class="string">,</span> <span class="string">"log"</span><span class="string">,</span> <span class="string">"prospector"</span><span class="string">,</span> <span class="string">"agent"</span><span class="string">,</span> <span class="string">"input"</span><span class="string">,</span> <span class="string">"beat"</span><span class="string">,</span> <span class="string">"offset"</span><span class="string">]</span></span><br><span class="line"><span class="attr">            ignore_missing:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    - type:</span> <span class="string">container</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">/var/log/containers/*strawhats*.log</span></span><br><span class="line"><span class="attr">      fields:</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">k8s-strawhats-log</span></span><br><span class="line"><span class="attr">      processors:</span></span><br><span class="line"><span class="attr">        - add_kubernetes_metadata:</span></span><br><span class="line"><span class="attr">            host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">            <span class="string">default_indexers.enabled:</span> <span class="literal">true</span></span><br><span class="line">            <span class="string">default_matchers.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            matchers:</span></span><br><span class="line"><span class="attr">            - logs_path:</span></span><br><span class="line"><span class="attr">                logs_path:</span> <span class="string">"/var/log/containers/"</span></span><br><span class="line"><span class="attr">        - drop_fields:</span></span><br><span class="line"><span class="attr">            fields:</span> <span class="string">["host",</span> <span class="string">"tags"</span><span class="string">,</span> <span class="string">"ecs"</span><span class="string">,</span> <span class="string">"log"</span><span class="string">,</span> <span class="string">"prospector"</span><span class="string">,</span> <span class="string">"agent"</span><span class="string">,</span> <span class="string">"input"</span><span class="string">,</span> <span class="string">"beat"</span><span class="string">,</span> <span class="string">"offset"</span><span class="string">,</span> <span class="string">"stream"</span><span class="string">]</span></span><br><span class="line"><span class="attr">            ignore_missing:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    processors:</span></span><br><span class="line"><span class="attr">      - add_cloud_metadata:</span></span><br><span class="line"><span class="attr">      - add_host_metadata:</span></span><br><span class="line">    <span class="string">setup.template.name:</span> <span class="string">"filebeat"</span></span><br><span class="line">    <span class="string">setup.template.pattern:</span> <span class="string">"filebeats-logs-*"</span></span><br><span class="line">    <span class="string">output.kafka:</span></span><br><span class="line"><span class="attr">      enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      hosts:</span> <span class="string">["10.154.8.208:9092","10.154.8.18:9092","10.154.8.112:9092"]</span></span><br><span class="line"><span class="attr">      topic:</span> <span class="string">"bi-devops-log"</span></span><br><span class="line"><span class="attr">      required_acks:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      compression:</span> <span class="string">gzip</span></span><br><span class="line"><span class="attr">      max_message_bytes:</span> <span class="number">1000000</span></span><br><span class="line">    <span class="string">setup.dashboards.index:</span> <span class="string">"filebeats-logs-*"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">      hostNetwork:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/filebeat:7.6.2</span></span><br><span class="line"><span class="attr">        args:</span> <span class="string">[</span></span><br><span class="line">          <span class="string">"-c"</span><span class="string">,</span> <span class="string">"/etc/filebeat.yml"</span><span class="string">,</span></span><br><span class="line">          <span class="string">"-e"</span><span class="string">,</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"9200"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_USERNAME</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">elastic</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTICSEARCH_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"sh_9527"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTIC_CLOUD_ID</span></span><br><span class="line"><span class="attr">          value:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ELASTIC_CLOUD_AUTH</span></span><br><span class="line"><span class="attr">          value:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">NODE_NAME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            fieldRef:</span></span><br><span class="line"><span class="attr">              fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          runAsUser:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/etc/filebeat.yml</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">filebeat.yml</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/filebeat/data</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"><span class="attr">          readOnly:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">varlog</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/log</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">0600</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">filebeat-config</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">varlog</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/var/log</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/var/lib/filebeat-data</span></span><br><span class="line"><span class="attr">          type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">- apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">namespaces</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">pods</span></span><br><span class="line"><span class="attr">  verbs:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">rest</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">9300</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">inter-node</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">"logstash"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/logstash:7.6.2</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">logstash-yml-config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/logstash/config/logstash.yml</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">logstash.yml</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">logstash-config</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/usr/share/logstash/pipeline/logstash.conf</span></span><br><span class="line"><span class="attr">          subPath:</span> <span class="string">logstash.conf</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">logstash-yml-config</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logstash-yml-config</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">logstash-config</span></span><br><span class="line"><span class="attr">        configMap:</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">logstash-config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># zookeeper</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">zookeeper-hs</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">2888</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">3888</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">leader-election</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">zookeeper-cs</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">2181</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">client</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  ensemble:</span> <span class="string">"zookeeper-0;zookeeper-1;zookeeper-2;zookeeper-3;zookeeper-4"</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="string">"5"</span></span><br><span class="line">  <span class="string">jvm.heap:</span> <span class="string">"1024M"</span></span><br><span class="line"><span class="attr">  tick:</span> <span class="string">"2000"</span></span><br><span class="line"><span class="attr">  init:</span> <span class="string">"10"</span></span><br><span class="line"><span class="attr">  sync:</span> <span class="string">"5"</span></span><br><span class="line">  <span class="string">client.cnxns:</span> <span class="string">"60"</span></span><br><span class="line">  <span class="string">snap.retain:</span> <span class="string">"3"</span></span><br><span class="line">  <span class="string">purge.interval:</span> <span class="string">"1"</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">zookeeper-pdb</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">  minAvailable:</span> <span class="number">3</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">zookeeper-hs</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        podAntiAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">            - labelSelector:</span></span><br><span class="line"><span class="attr">                matchExpressions:</span></span><br><span class="line"><span class="attr">                  - key:</span> <span class="string">"app"</span></span><br><span class="line"><span class="attr">                    operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                    values:</span></span><br><span class="line"><span class="bullet">                    -</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">              topologyKey:</span> <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/zookeeper:latest</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">2181</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">client</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">2888</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">3888</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">leader-election</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="string">"500m"</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="string">"2Gi"</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_ENSEMBLE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">ensemble</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_REPLICAS</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">              name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">              key:</span> <span class="string">replicas</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_HEAP_SIZE</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">jvm.heap</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_TICK_TIME</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">tick</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_INIT_LIMIT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">init</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_SYNC_LIMIT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">tick</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">name</span> <span class="string">:</span> <span class="string">ZK_MAX_CLIENT_CNXNS</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">client.cnxns</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ZK_SNAP_RETAIN_COUNT</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">snap.retain</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ZK_PURGE_INTERVAL</span></span><br><span class="line"><span class="attr">          valueFrom:</span></span><br><span class="line"><span class="attr">            configMapKeyRef:</span></span><br><span class="line"><span class="attr">                name:</span> <span class="string">zookeeper-config</span></span><br><span class="line"><span class="attr">                key:</span> <span class="string">purge.interval</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ZK_CLIENT_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"2181"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ZK_SERVER_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"2888"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">ZK_ELECTION_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"3888"</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"start-zookeeper \</span></span><br><span class="line"><span class="string">          --servers=5 \</span></span><br><span class="line"><span class="string">          --data_dir=/var/lib/zookeeper/data \</span></span><br><span class="line"><span class="string">          --data_log_dir=/var/lib/zookeeper/data/log \</span></span><br><span class="line"><span class="string">          --conf_dir=/opt/zookeeper/conf \</span></span><br><span class="line"><span class="string">          --client_port=2181 \</span></span><br><span class="line"><span class="string">          --election_port=3888 \</span></span><br><span class="line"><span class="string">          --server_port=2888 \</span></span><br><span class="line"><span class="string">          --tick_time=2000 \</span></span><br><span class="line"><span class="string">          --init_limit=10 \</span></span><br><span class="line"><span class="string">          --sync_limit=5 \</span></span><br><span class="line"><span class="string">          --heap=512M \</span></span><br><span class="line"><span class="string">          --max_client_cnxns=60 \</span></span><br><span class="line"><span class="string">          --snap_retain_count=5 \</span></span><br><span class="line"><span class="string">          --purge_interval=12 \</span></span><br><span class="line"><span class="string">          --max_session_timeout=40000 \</span></span><br><span class="line"><span class="string">          --min_session_timeout=4000 \</span></span><br><span class="line"><span class="string">          --log_level=INFO"</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          exec:</span></span><br><span class="line"><span class="attr">            command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          exec:</span></span><br><span class="line"><span class="attr">            command:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">"zookeeper-ready 2181"</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/lib/zookeeper</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">        emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        runAsUser:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteMany"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span> <span class="number">500</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kafka-svc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">9092</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kafka-pdb</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">  minAvailable:</span> <span class="number">2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">     matchLabels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">kafka-svc</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      affinity:</span></span><br><span class="line"><span class="attr">        podAntiAffinity:</span></span><br><span class="line"><span class="attr">          requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">            - labelSelector:</span></span><br><span class="line"><span class="attr">                matchExpressions:</span></span><br><span class="line"><span class="attr">                  - key:</span> <span class="string">"app"</span></span><br><span class="line"><span class="attr">                    operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                    values:</span> </span><br><span class="line"><span class="bullet">                    -</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">              topologyKey:</span> <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line"><span class="attr">        podAffinity:</span></span><br><span class="line"><span class="attr">          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="attr">             - weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">               podAffinityTerm:</span></span><br><span class="line"><span class="attr">                 labelSelector:</span></span><br><span class="line"><span class="attr">                    matchExpressions:</span></span><br><span class="line"><span class="attr">                      - key:</span> <span class="string">"app"</span></span><br><span class="line"><span class="attr">                        operator:</span> <span class="string">In</span></span><br><span class="line"><span class="attr">                        values:</span> </span><br><span class="line"><span class="bullet">                        -</span> <span class="string">zk</span></span><br><span class="line"><span class="attr">                 topologyKey:</span> <span class="string">"kubernetes.io/hostname"</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">300</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">k8s-kafka</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.41</span><span class="string">:8000/library/kafka:2.2.0</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="string">"4G"</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">1000</span><span class="string">m</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">9092</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">server</span></span><br><span class="line"><span class="attr">        command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">sh</span></span><br><span class="line"><span class="bullet">        -</span> <span class="bullet">-c</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"exec kafka-server-start.sh /opt/kafka/config/server.properties --override broker.id=$&#123;HOSTNAME##*-&#125; \</span></span><br><span class="line"><span class="string">          --override listeners=PLAINTEXT://:9092 \</span></span><br><span class="line"><span class="string">          --override zookeeper.connect=zookeeper-0.zookeeper-hs.log-prod.svc.cluster.local:2181,zookeeper-1.zookeeper-hs.log-prod.svc.cluster.local:2181,zookeeper-2.zookeeper-hs.log-prod.svc.cluster.local:2181,zookeeper-3.zookeeper-hs.log-prod.svc.cluster.local:2181,zookeeper-4.zookeeper-hs.log-prod.svc.cluster.local:2181 \</span></span><br><span class="line"><span class="string">          --override log.dir=/var/lib/kafka \</span></span><br><span class="line"><span class="string">          --override auto.create.topics.enable=true \</span></span><br><span class="line"><span class="string">          --override auto.leader.rebalance.enable=true \</span></span><br><span class="line"><span class="string">          --override background.threads=10 \</span></span><br><span class="line"><span class="string">          --override compression.type=producer \</span></span><br><span class="line"><span class="string">          --override delete.topic.enable=false \</span></span><br><span class="line"><span class="string">          --override leader.imbalance.check.interval.seconds=300 \</span></span><br><span class="line"><span class="string">          --override leader.imbalance.per.broker.percentage=10 \</span></span><br><span class="line"><span class="string">          --override log.flush.interval.messages=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override log.flush.offset.checkpoint.interval.ms=60000 \</span></span><br><span class="line"><span class="string">          --override log.flush.scheduler.interval.ms=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override log.retention.bytes=-1 \</span></span><br><span class="line"><span class="string">          --override log.retention.hours=168 \</span></span><br><span class="line"><span class="string">          --override log.roll.hours=168 \</span></span><br><span class="line"><span class="string">          --override log.roll.jitter.hours=0 \</span></span><br><span class="line"><span class="string">          --override log.segment.bytes=1073741824 \</span></span><br><span class="line"><span class="string">          --override log.segment.delete.delay.ms=60000 \</span></span><br><span class="line"><span class="string">          --override message.max.bytes=1000012 \</span></span><br><span class="line"><span class="string">          --override min.insync.replicas=1 \</span></span><br><span class="line"><span class="string">          --override num.io.threads=8 \</span></span><br><span class="line"><span class="string">          --override num.network.threads=3 \</span></span><br><span class="line"><span class="string">          --override num.recovery.threads.per.data.dir=1 \</span></span><br><span class="line"><span class="string">          --override num.replica.fetchers=1 \</span></span><br><span class="line"><span class="string">          --override offset.metadata.max.bytes=4096 \</span></span><br><span class="line"><span class="string">          --override offsets.commit.required.acks=-1 \</span></span><br><span class="line"><span class="string">          --override offsets.commit.timeout.ms=5000 \</span></span><br><span class="line"><span class="string">          --override offsets.load.buffer.size=5242880 \</span></span><br><span class="line"><span class="string">          --override offsets.retention.check.interval.ms=600000 \</span></span><br><span class="line"><span class="string">          --override offsets.retention.minutes=1440 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.compression.codec=0 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.num.partitions=50 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.replication.factor=3 \</span></span><br><span class="line"><span class="string">          --override offsets.topic.segment.bytes=104857600 \</span></span><br><span class="line"><span class="string">          --override queued.max.requests=500 \</span></span><br><span class="line"><span class="string">          --override quota.consumer.default=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override quota.producer.default=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.min.bytes=1 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.wait.max.ms=500 \</span></span><br><span class="line"><span class="string">          --override replica.high.watermark.checkpoint.interval.ms=5000 \</span></span><br><span class="line"><span class="string">          --override replica.lag.time.max.ms=10000 \</span></span><br><span class="line"><span class="string">          --override replica.socket.receive.buffer.bytes=65536 \</span></span><br><span class="line"><span class="string">          --override replica.socket.timeout.ms=30000 \</span></span><br><span class="line"><span class="string">          --override request.timeout.ms=30000 \</span></span><br><span class="line"><span class="string">          --override socket.receive.buffer.bytes=102400 \</span></span><br><span class="line"><span class="string">          --override socket.request.max.bytes=104857600 \</span></span><br><span class="line"><span class="string">          --override socket.send.buffer.bytes=102400 \</span></span><br><span class="line"><span class="string">          --override unclean.leader.election.enable=true \</span></span><br><span class="line"><span class="string">          --override zookeeper.session.timeout.ms=6000 \</span></span><br><span class="line"><span class="string">          --override zookeeper.set.acl=false \</span></span><br><span class="line"><span class="string">          --override broker.id.generation.enable=true \</span></span><br><span class="line"><span class="string">          --override connections.max.idle.ms=600000 \</span></span><br><span class="line"><span class="string">          --override controlled.shutdown.enable=true \</span></span><br><span class="line"><span class="string">          --override controlled.shutdown.max.retries=3 \</span></span><br><span class="line"><span class="string">          --override controlled.shutdown.retry.backoff.ms=5000 \</span></span><br><span class="line"><span class="string">          --override controller.socket.timeout.ms=30000 \</span></span><br><span class="line"><span class="string">          --override default.replication.factor=3 \</span></span><br><span class="line"><span class="string">          --override fetch.purgatory.purge.interval.requests=1000 \</span></span><br><span class="line"><span class="string">          --override group.max.session.timeout.ms=300000 \</span></span><br><span class="line"><span class="string">          --override group.min.session.timeout.ms=6000 \</span></span><br><span class="line"><span class="string">          --override inter.broker.protocol.version=2.2.0 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.backoff.ms=15000 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.dedupe.buffer.size=134217728 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.delete.retention.ms=86400000 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.enable=true \</span></span><br><span class="line"><span class="string">          --override log.cleaner.io.buffer.load.factor=0.9 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.io.buffer.size=524288 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.io.max.bytes.per.second=1.7976931348623157E308 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.min.cleanable.ratio=0.5 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.min.compaction.lag.ms=0 \</span></span><br><span class="line"><span class="string">          --override log.cleaner.threads=2 \</span></span><br><span class="line"><span class="string">          --override log.cleanup.policy=delete \</span></span><br><span class="line"><span class="string">          --override log.index.interval.bytes=4096 \</span></span><br><span class="line"><span class="string">          --override log.index.size.max.bytes=10485760 \</span></span><br><span class="line"><span class="string">          --override log.message.timestamp.difference.max.ms=9223372036854775807 \</span></span><br><span class="line"><span class="string">          --override log.message.timestamp.type=CreateTime \</span></span><br><span class="line"><span class="string">          --override log.preallocate=false \</span></span><br><span class="line"><span class="string">          --override log.retention.check.interval.ms=300000 \</span></span><br><span class="line"><span class="string">          --override max.connections.per.ip=2147483647 \</span></span><br><span class="line"><span class="string">          --override num.partitions=4 \</span></span><br><span class="line"><span class="string">          --override producer.purgatory.purge.interval.requests=1000 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.backoff.ms=1000 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.max.bytes=1048576 \</span></span><br><span class="line"><span class="string">          --override replica.fetch.response.max.bytes=10485760 \</span></span><br><span class="line"><span class="string">          --override reserved.broker.max.id=1000 "</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KAFKA_HEAP_OPTS</span></span><br><span class="line">          <span class="string">value</span> <span class="string">:</span> <span class="string">"-Xmx4096M -Xms4096M"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KAFKA_OPTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"-Dlogging.level=INFO"</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/lib/kafka</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          tcpSocket:</span></span><br><span class="line"><span class="attr">            port:</span> <span class="number">9092</span></span><br><span class="line"><span class="attr">          timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      securityContext:</span></span><br><span class="line"><span class="attr">        runAsUser:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">        fsGroup:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">  - metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteMany"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">      storageClassName:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line"><span class="attr">      resources:</span></span><br><span class="line"><span class="attr">        requests:</span></span><br><span class="line"><span class="attr">          storage:</span>  <span class="number">50</span><span class="string">G</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">bigdata</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">9998</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">9998</span></span><br><span class="line"><span class="attr">    nodePort:</span> <span class="number">30900</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">bigdata</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">kafka-manager:1.3.3.18</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">          containerPort:</span> <span class="number">9998</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">KMZK_HOSTS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">zk-cs.bigdata.svc.cluster.local:2181</span></span><br><span class="line"><span class="attr">        livenessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/api/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">        readinessProbe:</span></span><br><span class="line"><span class="attr">          httpGet:</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/api/health</span></span><br><span class="line"><span class="attr">            port:</span> <span class="string">kafka-manager</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">512</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">250</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">256</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LogStash</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">deployment.kubernetes.io/revision:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">  generation:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    k8s-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">    qcloud-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">log-prod</span></span><br><span class="line"><span class="attr">  selfLink:</span> <span class="string">/apis/apps/v1beta2/namespaces/default/deployments/logstash</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      k8s-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">      qcloud-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        k8s-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">        qcloud-app:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">PATH</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LANG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">C.UTF-8</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_HOME</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/usr/lib/jvm/java-8-openjdk-amd64</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_VERSION</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">8</span><span class="string">u111</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">JAVA_DEBIAN_VERSION</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">8</span><span class="string">u111-b14-2~bpo8+1</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">CA_CERTIFICATES_JAVA_VERSION</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"20140324"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">TZ</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">        image:</span> <span class="number">10.253</span><span class="number">.78</span><span class="number">.39</span><span class="string">:8000/library/logstash:7.6.2</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">container-logstash</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="string">"4"</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">8</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">4</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">        securityContext:</span></span><br><span class="line"><span class="attr">          privileged:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">        terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">        terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line"><span class="attr">      securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=
      
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://chuanyichuan.github.io/categories/Kubernetes/"/>
    
    
  </entry>
  
  <entry>
    <title>DDD设计架构初识</title>
    <link href="http://chuanyichuan.github.io/2021/08/16/DDD%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84%E5%88%9D%E8%AF%86/"/>
    <id>http://chuanyichuan.github.io/2021/08/16/DDD设计架构初识/</id>
    <published>2021-08-16T05:14:00.000Z</published>
    <updated>2021-08-18T08:34:49.299Z</updated>
    
    <content type="html"><![CDATA[<h4 id="领域"><a class="markdownIt-Anchor" href="#领域"></a> 领域</h4><p>领域：表示正在处理的现实世界中复杂的业务逻辑和规则构成的问题域</p><p>领域模型：对现实世界真实业务的抽象描述，与任何技术都无关</p><p>子域：整个业务领域的一部分，与微服务划分的粒度有关，包括核心域、支撑子域、通用子域</p><ul><li>核心域：核心业务，是一个有明确限界上下文的定义明确的业务领域模型，项目的核心业务体现，需重点打磨</li><li>支撑子域：支撑核心域，依据核心域内容进行“定制化”开发</li><li>通用子域：辅助核心域，拿来即用主义，不需要“定制化”</li></ul><hr><h4 id="基于数据库建模database-modeling"><a class="markdownIt-Anchor" href="#基于数据库建模database-modeling"></a> 基于数据库建模（Database Modeling）</h4><ul><li>通过数据抽象系统关系</li><li>贫血模型模式</li><li>通过数据库字段映射仅属性getter和setter，无具体行为</li><li>相应行为通过Service实现</li><li>日积月累容易出现胖服务层和贫血</li></ul><h4 id="基于对象建模object-modeling"><a class="markdownIt-Anchor" href="#基于对象建模object-modeling"></a> 基于对象建模（Object Modeling）</h4><ul><li>通过面向对象方式抽象系统关系</li><li>最佳的领域建模方式（不考虑持久化的情况）</li><li>充血模型模式</li><li>不仅包含属性状态，还包括具体行为</li><li>Service层逻辑变薄弱，模型丰富了行为</li></ul><hr><h4 id="领域模型"><a class="markdownIt-Anchor" href="#领域模型"></a> 领域模型：</h4><ul><li>对具有某个边界的领域的一个抽象，反映了领域内业务需求的本质</li><li>具有边界性，只反映我们在领域内所关注的部分</li><li>只反映业务，和任何技术实现无关</li><li>不仅能反映领域内的一些实体概念，还能反映领域中的一些过程概念</li><li>确保整个软件的业务逻辑都在一个模型中，提升了软件的可维护性、业务可理解性以及可重用性</li><li>帮助开发人员平滑的将领域知识转化为软件构造</li><li>贯穿软件分析、设计、整个开发过程，领域专家、设计人员、开发人员通过领域模型进行交流，可以有效的防止需求走样</li><li>领域模型必须由领域专家、设计、开发人员共同建立，一起不断的深入和细化模型</li><li>用图、代码或文字描述的形式表达领域模型，使其可见化</li><li>能够快速响应需求变化的领域模型必须设计的足够精良且符合业务需求</li></ul><hr><h4 id="实体entity"><a class="markdownIt-Anchor" href="#实体entity"></a> 实体（Entity）</h4><ul><li>一个由他的标识定义的对象称为实体</li><li>通常具有唯一id</li><li>能够被持久化</li><li>具有业务逻辑</li><li>对应现实世界的业务对象</li><li>一个持续抽象的生命，可以变化不同的形态和情形，但总有相同的标识</li><li>要防止设计成贫血模型</li></ul><h4 id="值对象value-object"><a class="markdownIt-Anchor" href="#值对象value-object"></a> 值对象（Value Object）</h4><ul><li>一个描述领域方面但没有概念标识符的的对象</li><li>用来表示临时的事物，可当作是实体的属性</li><li>没有特性标识，但能够表达领域中某类含义</li><li>一般不具有唯一id，由对象的属性描述，可以用来传递参数或对实体进行补充描述</li><li>作为实体属性的描述时，值对象也会被存储</li><li>对象不可变，所有属性均为只读，可以被复制或共享</li><li>本质上，值对象只是代表一个值</li></ul><blockquote><p>区别：</p><ol><li>唯一标识：实体有；值对象没有</li><li>对象判断：实体只看唯一标识是否相等；值对象看全部属性是否相等</li></ol></blockquote><h4 id="聚合及聚合根aggregate-aggregate-root"><a class="markdownIt-Anchor" href="#聚合及聚合根aggregate-aggregate-root"></a> 聚合及聚合根（Aggregate &amp; Aggregate Root）</h4><ul><li><p>定义领域对象的所有权和边界的领域模型</p></li><li><p>聚合帮助简化模型对象间的关系</p></li><li><p>通过定义对象之间清晰的所属关系和边界来实现领域模型的内聚，且避免了错综复杂难以维护的对象关系网的形成</p></li><li><p>聚合是对领域模型的深化，能阐释领域模型内部对象之间的深层关联，聚合关系会直接映射到程序结构上</p></li><li><p>一个聚合是一组相关的被视为整体的对象</p></li><li><p>每个聚合都有一个根对象（聚合根实体），根实体对象可以聚合所有对象的引用，但从外部访问只能通过这个根对象</p></li><li><p>仅根实体能使用仓储库直接查询，根实体被删除后，聚合内部的对象级联删除</p></li><li><p>聚合有一个根和一个边界，根是聚合内的某个实体，边界定义了一个聚合内部有哪些实体或值对象</p></li><li><p>聚合内部的对象之间可以相互引用，根为内部对象的唯一引用</p></li><li><p>聚合根对外负责与外部对象打交道，对内负责维护自己的内部业务规则</p></li><li><p>聚合内部对象可以拥有对其他聚合根的引用</p></li><li><p>聚合内的所有对象都必须同聚合根一起被删除</p></li></ul><h4 id="工厂factories"><a class="markdownIt-Anchor" href="#工厂factories"></a> 工厂（factories）</h4><ul><li>用来封装创建一个复杂对象，将创建对象的细节隐藏起来</li><li>通过简单入参创建复杂的领域对象，最终传出一个根实体</li></ul><h4 id="仓储repositories"><a class="markdownIt-Anchor" href="#仓储repositories"></a> 仓储（repositories）</h4><ul><li>管理实体的集合</li><li>仅存储聚合的对象（因为domain是以聚合的概念来划分边界，聚合作为一个整体，共存亡）</li><li>仓储定义部分+仓储实现部分=仓储</li><li>领域模型中定义仓储的接口</li><li>基础设施层实现具体的仓库</li><li>dao层方法粒度更细，更接近数据库；repository是一个独立的抽象，粒度略粗，接近领域</li><li>领域对象只依赖于repository</li><li>客户端调用领域对象，领域对象再调dao将数据持久化</li></ul><h4 id="服务service"><a class="markdownIt-Anchor" href="#服务service"></a> 服务（Service）</h4><ul><li>分派业务逻辑给领域对象进行处理，绝大部分的业务逻辑都由领域对象承载和实现</li><li>Service与其他组件进行交互，包括：其他Service、领域对象、repository、dao</li><li>代码必须非常简洁，必须实现对领域底层组件的调用</li><li>服务对象名称应包含一个动词</li><li>Service接口的传入/传出参数都应该是DTO</li><li>包含领域对象和DTO的转换以及事务</li><li>服务执行的操作涉及一个领域概念，这个领域概念通常不属于一个实体或者值对象</li><li>被执行的操作涉及到领域中其他的对象</li><li>操作是无状态的</li></ul><h4 id="domain事件"><a class="markdownIt-Anchor" href="#domain事件"></a> domain事件</h4><ul><li>系统事件、应用事件、领域事件</li><li>领域事件触发点在领域模型中</li><li>作用是将领域对象从repository和Service的依赖中解脱出来，避免让领域对象对这些设施产生直接依赖</li><li>作法就是当领域对象的业务方法需要依赖到这些对象时，就发出一个事件，这个事件会被相应的领域对象监听到，并做出处理</li><li>实现领域模型对象状态的异步更新、外部系统接口的委托调用、通过事件派发机制实现系统集成</li><li>领域事件本身具有自我描述性，不仅可以表达系统发生了什么事情，还能够描述发生事件的动机</li></ul><h4 id="dtodata-transfer-object"><a class="markdownIt-Anchor" href="#dtodata-transfer-object"></a> DTO（Data Transfer Object）</h4><ul><li>以粗粒度的数据结构减少网络通信并简化调用接口</li></ul><hr><h4 id="架构层次"><a class="markdownIt-Anchor" href="#架构层次"></a> 架构层次</h4><ul><li>层<ul><li>构成应用或服务的水平堆叠的一组逻辑上的组件</li><li>帮助区分完成不同任务的组件</li><li>提供一个最大化复用和可维护性的设计</li></ul></li></ul><p><img src="/images/%E9%A2%86%E5%9F%9F%E6%9E%B6%E6%9E%84%E5%B1%82%E6%AC%A1%E8%AE%BE%E8%AE%A1.jpg" alt="在这里插入图片描述"></p><ul><li>User Interface<ul><li>包含与其他系统/客户进行交互的接口与通信设施</li><li>该层包含web、service、rmi、rest等一种或多种通信接口</li><li>该层由facade、dto、assembler三类组件构成</li><li>dto：以粗粒度的数据结构减少网络通信并简化接口调用</li><li>facade：为远程客户端提供粗粒度的调用接口，本身不处理任何的业务逻辑，主要工作就是将一个用户请求委派给一个或多个service进行处理，同时借助assembler将service传入或传出的领域对象转为dto进行传输</li><li>assembler：将领域对象与dto进行相互转换</li></ul></li><li>Application<ul><li>主要组件就是service</li><li>service的组织粒度和接口设计与传统的transaction script风格的service是一致的，但又有区别</li><li>transaction script的核心是<strong>过程</strong>，通过过程的调用来组织业务逻辑，业务逻辑在服务层进行处理</li><li>transaction script简单容易理解，面向过程设计，基础设施不会有技术的改变，业务逻辑很少变动</li><li>transaction script不适合复杂的业务逻辑，事务之间的冗余代码会递增，应用架构容易出现“胖服务层”和“贫血的领域模型”，service层聚积越来越多的业务逻辑，导致可维护性和扩展性变差</li><li>transaction script的业务逻辑主要在service中实现</li><li>领域模型属于面向对象设计，具备自己的属性行为和状态，领域对象之间可以通过聚合解决实际的业务应用</li><li>领域模型可复用、可维护、可扩展，可以采用合适的设计模型进行详细设计</li><li>领域模型需要设计人员有良好的抽象能力，相对复杂</li><li>领域模型的service层只负责协调并委派业务逻辑给相应的领域对象进行处理</li></ul></li><li>Domain<ul><li>整个系统的核心层</li><li>该层维护一个使用面向对象技术实现的领域模型</li><li>该层实现大部分的业务逻辑，乃至全部的业务逻辑</li><li>该层包含entity、value object、domain event 和 repository等领域组件</li></ul></li><li>Infrastructure<ul><li>为User Interface、Application、Domain三层提供支撑</li><li>提供所有的与平台、框架相关的实现</li><li>提供对象持久化的具体实现</li></ul></li></ul><hr><h4 id="领域模型的设计步骤"><a class="markdownIt-Anchor" href="#领域模型的设计步骤"></a> 领域模型的设计步骤</h4><ol><li>根据需求建立一个初步的领域模型，识别出一些明显的领域概念以及它们的关联性，关联可以暂时没有方向但是必须有关系（1:1, 1:n, n:m），可以使用文字或图精确的描述出每个领域概念的含义和包含的主要信息</li><li>分析主要的软件应用程序，识别出主要的应用层的类，分清应用层和领域层的职责</li><li>进一步分析领域模型，识别出实体、值对象、领域服务</li><li>分析关联性，通过对业务的深入分析以及各种软件设计原则及性能方面的权衡，明确关联的方向（新增或删除）</li><li>☆找出聚合边界和聚合根，需要借助平时的一些分析经验的积累才能找出正确的聚合根</li><li>为聚合根配备仓储，一般情况下一个聚合分配一个仓储，设计好仓储的接口</li><li>分析场景，确定设计的领域模型能够有效的解决业务需求</li><li>确定领域实体和值对象的创建方式，比如工厂或构造函数</li><li>尝试重构模型，寻找模型中不确定的地方，比如领域对象是从仓储获取还是通过聚合得到，聚合设计是否正确，性能如何等等</li></ol><hr><h4 id="ddd特征"><a class="markdownIt-Anchor" href="#ddd特征"></a> DDD特征</h4><ul><li>一个以pojo为基础的架构</li><li>支持使用DDD概念的业务领域模型的设计和实现</li><li>支持依赖注入和面向切面编程的开箱即用</li><li>整合单元测试框架</li><li>良好的集成其他javaee框架</li></ul><hr><h4 id="领域模型分类"><a class="markdownIt-Anchor" href="#领域模型分类"></a> 领域模型分类</h4><ul><li><p>失血模型</p><ul><li>domain object中的属性只有getter/setter方法</li><li>所有的业务逻辑均由business object完成（又称transaction script）</li></ul></li><li><p>贫血模型</p><ul><li>Service(Transaction script) —&gt; DAO —&gt; domain object</li><li>domain object包含了不依赖于持久化的领域逻辑</li><li>依赖于持久化的领域逻辑被分离到service层</li><li>domain logic 和 business logic</li><li>domain logic只和这一个domain object的实例状态有关</li><li>business logic可以和多个domain object的实例状态有关</li><li>将domain logic放到domain object之后，domain object仍独立于持久层之外，且仍是一个完备的、自包含的、不依赖于外部环境的领域对象</li><li>在service中执行与持久层相关的业务逻辑</li><li>各层单向依赖，结构清晰，易于实现和维护</li><li>设计简单易行，底层模式非常稳定</li></ul></li><li><p>充血模型</p><ul><li>Service(Transaction script) —&gt; domain object &lt;—&gt; DAO</li><li>与贫血模型的区别在于业务逻辑的划分</li><li>大部分业务逻辑都放在domain object中，包括持久化逻辑</li><li>domain object中包含了domain logic 和 business logic</li><li>Service层仅封装事务和少量逻辑，不和DAO层打交道</li></ul><blockquote><p>缺点</p></blockquote><ul><li>DAO和domain相互依赖，会导致很多潜在问题</li><li>Service层逻辑和domain层逻辑对于水平参差的设计和开发人员来说容易含混不清</li><li>Service层需要对domain object的逻辑提供相应的事务，结果会导致Service层把所有的domain logic都重新定义一遍，最终把domain层实现的OO在Service层又变成了过程式</li></ul></li><li><p>胀血模型</p><ul><li>domain object &lt;—&gt; DAO</li><li>去掉service层</li><li>在domain logic上封装事务</li></ul><blockquote><p>缺点</p></blockquote><ul><li>过多的service逻辑耦合到domain object中，会引起domain object模型的不稳定</li><li>domain object暴露过多的信息给web层，可能会引起不必要的影响</li></ul><blockquote><p>比较</p></blockquote><ul><li>失血模型和胀血模型不推荐</li><li>推荐使用贫血模型</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;领域&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#领域&quot;&gt;&lt;/a&gt; 领域&lt;/h4&gt;
&lt;p&gt;领域：表示正在处理的现实世界中复杂的业务逻辑和规则构成的问题域&lt;/p&gt;
&lt;p&gt;领域模型：对现实世界真实业务的抽象描述，与任何技术都无关&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="DDD" scheme="http://chuanyichuan.github.io/categories/DDD/"/>
    
    
  </entry>
  
  <entry>
    <title>Raft协议探析</title>
    <link href="http://chuanyichuan.github.io/2021/07/22/Raft%E5%8D%8F%E8%AE%AE%E6%8E%A2%E6%9E%90/"/>
    <id>http://chuanyichuan.github.io/2021/07/22/Raft协议探析/</id>
    <published>2021-07-22T15:23:00.000Z</published>
    <updated>2021-07-23T05:59:32.953Z</updated>
    
    <content type="html"><![CDATA[<p>前两天和朋友们交流，开完车后话题突然转到了分布式共识算法上，猝不及防的给我摔了个大跟头。但是说到分布式共识算法，不免就会说到几个一致性协议，比如Paxos、Raft、Gossip等等，但说共识算法那必定是要先了解什么是分布式，然后根据分布式带来的问题才能知道为什么这些算法叫共识算法，也能知道到底是为来了解决什么问题而存在。</p><h3 id="分布式架构"><a class="markdownIt-Anchor" href="#分布式架构"></a> 分布式架构</h3><p>有些没接触过分布式系统的同学可能对什么是分布式不是很清楚，也有很多人对分布式和集群很容易混淆，所以我们先看一下架构上的演变过程。</p><h4 id="单体架构"><a class="markdownIt-Anchor" href="#单体架构"></a> 单体架构</h4><p>单体架构属于是上古神兽了，这并不是说它过时了，即使放在当前时代，也是可以的，只不过可能就只能适用于流量较小的系统，或者是可用性要求不那么高的系统。</p><img src="/Users/chuan/Documents/projects_code/git-project/github_blog/source/images/image-20210723134441870.png" alt="image-20210723134441870" style="zoom: 33%;"><h4 id="集群架构"><a class="markdownIt-Anchor" href="#集群架构"></a> 集群架构</h4><h4 id="分布式架构-2"><a class="markdownIt-Anchor" href="#分布式架构-2"></a> 分布式架构</h4>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前两天和朋友们交流，开完车后话题突然转到了分布式共识算法上，猝不及防的给我摔了个大跟头。但是说到分布式共识算法，不免就会说到几个一致性协议，比如Paxos、Raft、Gossip等等，但说共识算法那必定是要先了解什么是分布式，然后根据分布式带来的问题才能知道为什么这些算法叫
      
    
    </summary>
    
    
      <category term="分布式" scheme="http://chuanyichuan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>Mysqldump备份与恢复</title>
    <link href="http://chuanyichuan.github.io/2021/07/04/mysqldump%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"/>
    <id>http://chuanyichuan.github.io/2021/07/04/mysqldump备份与恢复/</id>
    <published>2021-07-04T12:00:00.000Z</published>
    <updated>2021-07-05T13:53:14.970Z</updated>
    
    <content type="html"><![CDATA[<p>这几天对服务进行研发区迁移，一直在研究迁移方案，因为涉及关联的服务过多，所以最初大致定了一个粗略的方案，步骤：</p><ol><li>网络策略</li><li>迁移X服务</li><li>迁移数据</li><li>迁移附属服务</li><li>迁移附属数据</li><li>网络策略调试</li><li>服务测试</li></ol><p>网络1、2、4~7就不说了，主要来说一下第3项迁移数据。为了迁移数据，我们想了几种方案，但主要分两个方向：停服迁移和不停服迁移。这两种方案最安全可靠的当属停服迁移，但</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;这几天对服务进行研发区迁移，一直在研究迁移方案，因为涉及关联的服务过多，所以最初大致定了一个粗略的方案，步骤：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;网络策略&lt;/li&gt;
&lt;li&gt;迁移X服务&lt;/li&gt;
&lt;li&gt;迁移数据&lt;/li&gt;
&lt;li&gt;迁移附属服务&lt;/li&gt;
&lt;li&gt;迁移附属数据&lt;/l
      
    
    </summary>
    
    
      <category term="MySQL" scheme="http://chuanyichuan.github.io/categories/MySQL/"/>
    
    
  </entry>
  
  <entry>
    <title>LibreSSL SSL_connect SSL_ERROR_SYSCALL in Connection to github.com 443</title>
    <link href="http://chuanyichuan.github.io/2021/06/16/LibreSSL-SSL_connect-SSL_ERROR_SYSCALL-in-connection-to-github.com443/"/>
    <id>http://chuanyichuan.github.io/2021/06/16/LibreSSL-SSL_connect-SSL_ERROR_SYSCALL-in-connection-to-github.com443/</id>
    <published>2021-06-16T07:00:00.000Z</published>
    <updated>2021-08-18T08:38:35.239Z</updated>
    
    <content type="html"><![CDATA[<p>macOS系统偶尔会遇到此问题，大多是因为协议问题，解决办法就是修改一下协议：</p><p>文件：<code>~/.gitconfig</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[http]</span><br><span class="line">postBuffer = 524288000</span><br><span class="line">  sslBackend = openssl</span><br><span class="line">  proxy = socks5://127.0.0.1:7890</span><br></pre></td></tr></table></figure><p>这里的端口可以查看自己的设置，在此因为有科学上网，所以查看了下科学上网的端口：</p><img src="/images/image-20210616150258821.png" alt="image-20210616150258821" style="zoom:50%;">]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;macOS系统偶尔会遇到此问题，大多是因为协议问题，解决办法就是修改一下协议：&lt;/p&gt;
&lt;p&gt;文件：&lt;code&gt;~/.gitconfig&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut
      
    
    </summary>
    
    
      <category term="BUG" scheme="http://chuanyichuan.github.io/categories/BUG/"/>
    
    
  </entry>
  
  <entry>
    <title>The Mono Returned by the Supplier Is Null</title>
    <link href="http://chuanyichuan.github.io/2021/05/30/The-Mono-returned-by-the-supplier-is-null/"/>
    <id>http://chuanyichuan.github.io/2021/05/30/The-Mono-returned-by-the-supplier-is-null/</id>
    <published>2021-05-30T04:12:00.000Z</published>
    <updated>2021-05-31T14:06:25.847Z</updated>
    
    <content type="html"><![CDATA[<p>SpringCloud Gateway启动报错：The Mono returned by the supplier is null</p><blockquote><p>解决</p></blockquote><p>有自定义的Filter返回了null，找到它，干掉它，就好了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;SpringCloud Gateway启动报错：The Mono returned by the supplier is null&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;解决&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;有自定义的Filter返回了null，找到它，干掉它，
      
    
    </summary>
    
    
      <category term="SpringCloud" scheme="http://chuanyichuan.github.io/categories/SpringCloud/"/>
    
    
      <category term="网关" scheme="http://chuanyichuan.github.io/tags/%E7%BD%91%E5%85%B3/"/>
    
      <category term="Gateway" scheme="http://chuanyichuan.github.io/tags/Gateway/"/>
    
  </entry>
  
  <entry>
    <title>Spring参数注入方式</title>
    <link href="http://chuanyichuan.github.io/2021/05/20/Spring%E5%8F%82%E6%95%B0%E6%B3%A8%E5%85%A5%E6%96%B9%E5%BC%8F/"/>
    <id>http://chuanyichuan.github.io/2021/05/20/Spring参数注入方式/</id>
    <published>2021-05-20T04:30:00.000Z</published>
    <updated>2021-05-25T02:32:13.065Z</updated>
    
    <content type="html"><![CDATA[<p>开发过程中经常会遇到参数配置化的情景，参数的类型也可以是多种多样的，记录一下各类型从配置文件中的加载方式，给当前创建一个savepoint。</p><blockquote><p>配置一个properties文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> <span class="string">cc.common=abcdef</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">cc.list=a,b,c,d,e,f</span></span><br><span class="line"><span class="meta">&gt;</span> <span class="string">cc.map=&#123;key1: '1', key2: '2', key3: '3'&#125;</span></span><br><span class="line"><span class="attr">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="基础案例"><a class="markdownIt-Anchor" href="#基础案例"></a> 基础案例</h3><h4 id="1-字符串"><a class="markdownIt-Anchor" href="#1-字符串"></a> 1. 字符串</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常规情况</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;cc.common&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String common;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自带默认值情况</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;cc.common1:aaa&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String commonDefault;</span><br></pre></td></tr></table></figure><h4 id="2-数组"><a class="markdownIt-Anchor" href="#2-数组"></a> 2. 数组</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;cc.list&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String[] array;</span><br></pre></td></tr></table></figure><h4 id="3-list"><a class="markdownIt-Anchor" href="#3-list"></a> 3. List</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;'$&#123;cc.list&#125;'.split(',')&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; list;</span><br></pre></td></tr></table></figure><h4 id="3-map"><a class="markdownIt-Anchor" href="#3-map"></a> 3. Map</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 常规情况</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;$&#123;cc.map&#125;&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Integer&gt; map;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单独某个key的value</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;$&#123;cc.map&#125;.key1&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Integer value;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据value进行过滤</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;$&#123;cc.map&#125;.?[value&gt;'1']&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Integer&gt; mapFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认值</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;$&#123;cc.map:&#123;key1: '11', key2: '12'&#125;&#125;&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Integer&gt; map;</span><br></pre></td></tr></table></figure><img src="/images/image-20210525094552803.png" alt="image-20210525094552803" style="zoom:50%;"><h4 id="4-自定义对象"><a class="markdownIt-Anchor" href="#4-自定义对象"></a> 4. 自定义对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"cc"</span>)</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesInject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String common;</span><br><span class="line">  <span class="keyword">private</span> String[] list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/images/image-20210525093735644.png" alt="image-20210525093735644" style="zoom: 67%;"><h4 id="5-项目变量"><a class="markdownIt-Anchor" href="#5-项目变量"></a> 5. 项目变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有系统变量</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;@systemProperties&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String               systemProperty;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取指定系统变量</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;@systemProperties['user.dir']&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String               systemPropertyList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有系统变量，并以Map存储</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;@systemProperties&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, String&gt;  systemPropertyMap;</span><br></pre></td></tr></table></figure><img src="/images/image-20210525100217655.png" alt="image-20210525100217655" style="zoom:50%;"><h4 id="6-系统环境变量"><a class="markdownIt-Anchor" href="#6-系统环境变量"></a> 6. 系统环境变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有系统环境变量</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;@systemEnvironment&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, String&gt;  systemEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取指定环境变量的值</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;@systemEnvironment['PATH']&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String               systemEnvironmentPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认值</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"#&#123;@systemEnvironment['abc']?:'snowman'&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String               systemEnvironmentDefault;</span><br></pre></td></tr></table></figure><p><img src="/images/image-20210525101031848.png" alt="image-20210525101031848"></p><h3 id="注入方式"><a class="markdownIt-Anchor" href="#注入方式"></a> 注入方式</h3><h4 id="1-属性注入"><a class="markdownIt-Anchor" href="#1-属性注入"></a> 1. 属性注入</h4><p>就是上方案例中的注入方式</p><h4 id="2-构造器注入"><a class="markdownIt-Anchor" href="#2-构造器注入"></a> 2. 构造器注入</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:values.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesInject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; values = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(@Value(<span class="string">"#&#123;'$&#123;cc.list&#125;'.split(',')&#125;"</span>)</span> List&lt;String&gt; values) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.values.addAll(values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-setter注入"><a class="markdownIt-Anchor" href="#3-setter注入"></a> 3. Setter注入</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:values.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesInject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; values = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(@Value(<span class="string">"#&#123;'$&#123;cc.list&#125;'.split(',')&#125;"</span>)</span> List&lt;String&gt; values) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.values.addAll(values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-类统一注入"><a class="markdownIt-Anchor" href="#4-类统一注入"></a> 4. 类统一注入</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"cc"</span>)</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesInject</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String common;</span><br><span class="line">  <span class="keyword">private</span> String[] list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;开发过程中经常会遇到参数配置化的情景，参数的类型也可以是多种多样的，记录一下各类型从配置文件中的加载方式，给当前创建一个savepoint。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;配置一个properties文件&lt;/p&gt;
&lt;figure class=&quot;highlight 
      
    
    </summary>
    
    
      <category term="Spring" scheme="http://chuanyichuan.github.io/categories/Spring/"/>
    
    
  </entry>
  
  <entry>
    <title>微信抢红包设计</title>
    <link href="http://chuanyichuan.github.io/2021/05/18/%E5%BE%AE%E4%BF%A1%E6%8A%A2%E7%BA%A2%E5%8C%85%E8%AE%BE%E8%AE%A1/"/>
    <id>http://chuanyichuan.github.io/2021/05/18/微信抢红包设计/</id>
    <published>2021-05-17T17:22:00.000Z</published>
    <updated>2021-05-26T07:09:07.516Z</updated>
    
    <content type="html"><![CDATA[<h3 id="a"><a class="markdownIt-Anchor" href="#a"></a> A</h3><p>现在的工作或面试中，很多人动辄就会被问到高并发的问题，但并不是所有研发同学都有机会参与到并发很高的项目中，很多人准备这块内容也纯粹是为了面试，真正的工作中，还是单纯的CRUD，那么高并发就不重要了吗？那是相当的重要，重要到你不会就通不过面试的程度。高并发可以是高接口、高服务、高系统，这次就从微信抢红包来简单的说说这块。</p><p>在设计之前，先来拆解一下微信抢红包的大致流程：发红包、扣款、收红包、拆红包、领取金额、入账、查看红包领取记录、红包被领取通知。从这7个步骤着手简单分析一下（实际不止这几个），这几项哪些是会影响用户体验的呢？感觉每一个都会，但相对来说收红包、拆红包的实时性体验更重要，并且这两者属于是并发量最高的，比如在一个100人的群中发一个10人份的红包，来分析一下请求量：</p><table><thead><tr><th>Action</th><th>Request Quantity</th></tr></thead><tbody><tr><td>发红包</td><td>1</td></tr><tr><td>扣款</td><td>1</td></tr><tr><td>收红包</td><td>100</td></tr><tr><td>拆红包</td><td>100</td></tr><tr><td>领取金额</td><td>10~100</td></tr><tr><td>入账</td><td>10</td></tr><tr><td>查看红包领取记录</td><td>100+</td></tr><tr><td>红包被领取通知</td><td>10</td></tr><tr><td>其他</td><td>…</td></tr></tbody></table><p>实际上对于一个红包来说，可能带来群内用户数的请求量，如果放在一个五百人的群中，那么一个收红包的请求数可能就会达到500，春晚期间每秒百万个红包，则带来的请求量就是一秒几个亿的级别，当然这是一个理论上的数据，如果想要达到几个亿的并发量，那我不会~</p><h3 id="分析"><a class="markdownIt-Anchor" href="#分析"></a> 分析</h3><h4 id="1-硬件"><a class="markdownIt-Anchor" href="#1-硬件"></a> 1. 硬件</h4><p>硬件么，也就是服务器了，常常被调侃的往往最有效：出现了并发瓶颈怎么办？答：加机器！加内存！加磁盘！加带宽！是不是当听到这个回答之后感觉对方挺没意思，那么如果在工程的JVM、代码、队列、缓存等等一系列都完善好了，这时候怎么办？只能具体问题具体分析了：如果瓶颈在内存上，那么就加内存；如果瓶颈在磁盘上，空间不足那么就加磁盘，写读速度太低，那么就换SSD；如果瓶颈在CPU上，那么就加机器，横向扩充CPU；如果是网络问题，那么就加带宽。</p><p>通过以上分析，是不是觉得加机器还是挺有道理的。加机器会带来的优势：内存大、磁盘读写快、CPU管够、网络嗖嗖的</p><h4 id="2-代码"><a class="markdownIt-Anchor" href="#2-代码"></a> 2. 代码</h4><p>在加机器之前，都应该先把服务工程的代码优化到极致，代码优化就不细说了，属于是日常积累。</p><h4 id="3-锁"><a class="markdownIt-Anchor" href="#3-锁"></a> 3. 锁</h4><p>乐观锁和悲观锁的正确使用能够带来不同的性能指标，</p><h3 id="设计"><a class="markdownIt-Anchor" href="#设计"></a> 设计</h3><h4 id="1-发收红包"><a class="markdownIt-Anchor" href="#1-发收红包"></a> 1. 发收红包</h4><p>红包的并发有多高？简单的计算一下：十万个人，每个人同时发一个红包，发红包的并发量就是十万，但实际上在高峰期时期，不可能只有十万个人在发红包。拒资料记载：在2017年除夕当天，收发微信红包的数量达到了142亿，按照一天86400秒计算的话，平均每秒就有16万个红包发出，也就是持续一整天每秒并发16万，当然流量不可能这么平均，资料上记录当天最高峰值达到了76万每秒，是平均值的5倍左右。</p><p>发红包是允许发送失败(告诉用户网络问题，让用户自我怀疑)，但不允许发送成功之后丢失数据，因为涉及到钱，数据安全性和一致性的要求必须非常高，先不考虑数据的安全性和一致性，这里可以使用中间件来保证。在并发量较高的情况下，发红包请求发出之后，服务器并不能每一个请求都及时处理，所以这里如果把同步搞为异步，会解决什么问题（不涉及扣款）：</p><blockquote><p>同步</p></blockquote><p><code>接收发红包请求-&gt;通知群内所有人-&gt;全部通知完成-&gt;反馈用户红包发送成功-&gt;准备接收发红包请求</code></p><p>从同步请求来看，一台实例每次只能处理一个请求，如果红包通知的目标人群数量庞大，那么这将是非常耗时的操作，并且如果其中一个用户通知失败（中途有人退群），还可能会影响到全部的通知，造成的延迟将不可预估。当每台实例每秒只能处理一个请求的时候，高峰期的76万个并发则需要76万台实例，公司没那么多银子，砸不起。</p><blockquote><p>异步</p></blockquote><p><code>1. 接收发红包请求-&gt;存入消息队列-&gt;反馈用户红包发送成功-&gt;准备接收发红包请求</code></p><p><code>2. 发红包消息处理器-&gt;拆解消息通知-&gt;存入消息队列</code></p><p><code>3. 通知消息处理器-&gt;发送通知</code></p><p>接着就是异步处理，服务端接收到发红包请求之后立即将请求放入发红包消息处理队列，然后立即反馈用户发送成功，这里耗时的地方只有与消息队列通信这一个，在网络正常的情况下，耗时微乎其微。发红包的请求入队之后按顺序排排好，等待消费端进行消费处理（这里要保证消息不能丢失），接下来就是消息处理器的工作了，对于发红包的用户来说红包已经发成功了，其他人啥时候收到就不关我事了，反正我发出去了。</p><p>至于消息消费的效率问题，就属于是消息中间件的吞吐量问题了，选择和配置相关参数提升吞吐量不算太难的事情，关键要有银子，不然买不起好的机器也没太大用处。发红包消息处理器对收到的消息进行拆解，按用户进行拆分，将拆分后的数据封装成一条条通知消息，并将通知消息放入到通知消息队列中，至于顺序，那就关系不大了，这里一般不需要保证有序，因为没有必要保证收到消息的用户要按照入群的顺序来啊，不然如果真因为网络问题或者中间件吞吐量问题造成了延迟，本群抢到红包的就永远都是最先入群的那几个人了。</p><p>通知消息处理器从队列中依次处理消息，按个儿通知用户，此刻用户就能发现有一个红包出现。消息通知晚的那就只能手慢无了。</p><p><em><strong>所以有时候抢不到红包不一定是你手速慢，也可能是没那个命</strong></em></p><h4 id="2-拆红包"><a class="markdownIt-Anchor" href="#2-拆红包"></a> 2. 拆红包</h4><p>当我们看到红包之后，也不知道它有没有被抢完，第一反应肯定都是我要点它，点击红包会有一个加载的过程，加载的过程就是在向后台请求当前时刻红包是否已被抢完，如果没被抢完则会出现一个大大的<strong>開</strong>，点击开抢（一直没搞明白为什么不依据定向红包、手气红包这种红包类型变更按钮，比如定向叫拆[没福气被拆迁，可以被拆红包也不错]，或者手气红包叫抢[不知道是不是有限制不能用抢这个字]）。</p><p>​<img src="/images/image-20210525115828021.png" alt="image-20210525115828021" style="zoom:50%; ">               <img src="/images/image-20210525120415369.png" alt="image-20210525120415369" style="zoom:50%;"></p><p>那么加载过程是异步还是同步的呢？如果是异步请求，那么请求发送出去立即返回，等异步处理完后再反馈到客户端，如果异步排队的话，那这个请求时长就不可控了，所以这里按照操作行为来看，采用同步请求更适合，既然是同步请求，那么在请求返回之前就需要hang住线程资源，所以就只能想办法把hang住的时间变短，这个时候缓存好像就起到了很大的作用，如果单纯的使用数据库，在数据库资源竞争上又是一个大问题，涉及到数据的变更，必定要和数据库锁打交道，锁又是性能首害，而用Redis的话，天生的单线程处理+reactor主从线程池模型提供了高性能保障，将读写压力从数据库转移到每秒几万并发的Redis，请求时间缩短很多，直接的提升了加载接口的并发量。</p><p>那么是不是每一次点击红包都要去后台请求一次状态呢？当然不行，已经被领取完的红包还去后台请求干啥？钱会退回来吗，还是状态会变？所以已经被领取完的红包信息完全可以在客户端缓存一份，每次请求就不用和服务端进行通信了，把流量控制在客户端，减缓服务端的压力，同时也提升了用户体验（没有网络请求比本地请求快的道理），哦吼，好像不错~</p><p>点击红包的动作就这，就是一个<strong>同步请求+服务端远程缓存+客户端缓存</strong>。</p><p>继续深入思考一下，这几个步骤还有哪一步可以继续优化一下，同步改异步在前面已经说过了，好像可行性不高，客户端缓存可以减少网络请求，性能提升也挺高，好像也没有更优的方案了，那么就只剩服务端远程缓存了，上面讨论到服务端缓存使用Redis，也就是一个分布式缓存，使用Redis的目的就是不论请求路由到哪一个节点都可以访问到同一个资源，大致的流程是这样的：</p><p><code>服务端接收请求-&gt;与Redis服务器发送请求-&gt;读取Redis数据-&gt;Redis服务器返回数据-&gt;服务端返回数据</code></p><p>如果采用本地缓存的话，会是什么样子呢？看下流程：</p><p><code>服务端接收请求-&gt;读取本地缓存数据-&gt;服务端返回数据</code></p><p>少了与Redis服务器建立连接的过程，在网络资源紧张的情况下，每秒几十万次读，好像问题也不大（不要说Redis单机只几万，哪个公司产线会只用一台单机版的Redis），每次读耗时0.00001秒的话，70万次就是7秒，貌似挺多的，并且一次读取也不可能只0.00001秒的时间，所以这里对于当前业务来说属于一个可优化的性能瓶颈，优化的点就是把访问远程内存改为访问本地内存，减少网络开销，直接读取服务实例所在机器内存，效率绝对杠杠的。</p><p>使用本地缓存可以提升性能，但是会带来另一个问题：只有关于这个红包的所有请求都发送到固定的一台机器上，才能正确的使用本地缓存，否则如果出现请求离散的情况，本地缓存就是一个诟病了。所以如果想使用本地缓存的话，我们就要控制请求路由，让同一个红包的请求都发送到固定的一台实例上，这要怎么整？我们知道常用的请求路由方式有：轮询、权重、ip-hash、fair（第三方）、url-hash（第三方），轮询好像不行，每一次请求都被路由到不同的实例上，权重好像也不行，ip-hash只能够保证同一个客户端的请求路由到固定的实例，fair是按后端服务器的响应时间来分配请求，更不合适了，还有一种根据url计算hash，也不合适，不可能所有的请求都是一个hash值。常用的路由好像都不合适，但是我们发现了一种能让指定请求都路由到一台实例上的方式，ip-hash和url-hash，那么我们能不能针对红包搞一个read-packet-hash算法，将同一个红包的所有操作请求都路由到一台实例上，貌似可以，那么就不介绍具体实现了，网关层做控制很简单：对每一个红包在创建的时候都生成一个全局唯一ID，后续针对这个ID计算哈希进行路由。</p><p>使用本地缓存的话，如果有人杠起来：一台实例挂了的话岂不是这台实例的所有红包数据都丢失了？那你咋说？当然怼回去：Redis某ms节点挂了的话影响的服务实例更多，咋整？只能尽可能的保证节点的稳定性，但也不是说使用了本地缓存就弃用远程缓存，两者是相辅相成、互相同步的关系：本地-&gt;远程 &amp;&amp; 远程-&gt;本地。</p><h4 id="3-领取金额"><a class="markdownIt-Anchor" href="#3-领取金额"></a> 3. 领取金额</h4><p>红包都被拆开了，是不是就可以分钱了呢？是的，可以分钱了，分钱的并发量在红包数量~群内人数之间，为什么说能够达到群内人数这么高的并发，如果所有人都在同一时刻点开红包然后同一秒内点<strong>開</strong>，那么领红包的接口并发量就上来了，领取功能简单，关键就在于金额怎么分配，我们依据单例的懒汉模式和饿汉模式来分析一下：</p><blockquote><p>懒汉模式</p></blockquote><p>懒汉模式就是每一个请求来到之后再做相应的处理，数据处理为同步的。</p><blockquote><p>饿汉模式</p></blockquote><p>饿汉模式就是在请求到来之前，先把数据准备好，数据处理为异步的。</p><hr><p>这两种模式应该怎么选择？同步模式下，每次请求都需要通过算法计算一次所得金额，并发情况下需要争抢同一个资源，每一次计算的耗时造成过多的锁等待；而异步模式下，在抢红包请求到来之前，每个人所得金额都已经排好排等着被领走了，只需要依据先来先得的规则按需取走即可，计算时间成本下降了，锁等待时间就相应的下降了，并发就提升了。</p><p><em><strong>1…异步刷库到账</strong></em></p><h4 id="4-查看红包领取记录"><a class="markdownIt-Anchor" href="#4-查看红包领取记录"></a> 4. 查看红包领取记录</h4><p>查看红包领取记录属于是一个常规Action，不论什么时候都可以查看过往红包的领取记录，上面讲了可以将已领完的红包数据缓存到客户端，那么在服务端怎么处理？Elasticsearch、MongoDB、HBASE这些先不讨论，就拿MySQL来说，除夕一天142亿个红包，如果平均每个红包都有10个小包，那就是1420亿条领取记录，突然一下给整不会了，没处理过这么大的数据量，我先想想</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;a&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#a&quot;&gt;&lt;/a&gt; A&lt;/h3&gt;
&lt;p&gt;现在的工作或面试中，很多人动辄就会被问到高并发的问题，但并不是所有研发同学都有机会参与到并发很高的项目中，很多人准备这块内容也纯粹是为了面试，真正的工
      
    
    </summary>
    
    
      <category term="架构设计" scheme="http://chuanyichuan.github.io/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"/>
    
    
      <category term="面试" scheme="http://chuanyichuan.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>整理面试题</title>
    <link href="http://chuanyichuan.github.io/2021/05/17/%E6%95%B4%E7%90%86%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <id>http://chuanyichuan.github.io/2021/05/17/整理面试题/</id>
    <published>2021-05-17T10:09:00.000Z</published>
    <updated>2021-05-22T15:55:21.125Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>JVM频繁FGC如何排查，FGC的原因是什么，如何减少FGC</p></li><li><p>怎么查看GC日志，GC日志关注哪些内容，通过这些内容能总结出什么问题</p></li><li><p>spring事务的具体实现是怎么做的，事务为什么会失效，针对失效的事务怎么优化</p></li><li><p>锁在spring事务中的使用方式，spring事务内锁的释放方式</p></li><li><p>JVM内存有哪些区域，这些区域的上层是什么，除了堆，还有什么</p></li><li><p>什么情况下会出现FGC，出现FGC后如何排查代码，出现FGC后如何定位JVM堆内存问题</p></li><li><p>栈溢出的怎么排查问题，什么情况下栈会OOM</p></li><li><p>如何把方法区撑爆</p></li><li><p>发生一次FGC之后，堆内存未释放过多，如何排查原因</p></li><li><p>当JVM堆内存溢出后，其他线程是否可继续工作</p></li><li><p>MySQL锁有几种，间隙锁如何实现的，和隔离级别有什么关系</p></li><li><p>隔离级别默认是哪个，如果改成RC会出现什么问题，RR如何解决幻读的(MVCC)</p></li><li><p>MySQL的索引有几种类型，结构是什么，索引什么情况下会不生效，怎么查看SQL是否用到了索引</p></li><li><p>组合索引a,b,c，order by c,b,a会用到索引吗，为什么</p></li><li><p>explain中的extra中的using index和using filesort的区别</p></li><li><p>explain中需要关注哪些属性字段，意义分别是什么</p></li><li><p>一条SQL最多会使用多少个索引</p></li><li><p>a、b、c三个字段，组合索引ab、ac、bc，where中使用到a=? and b=? and c=?，会命中哪一个索引，为什么</p></li><li><p>如何排查MySQL的慢查询语句</p></li><li><p>一条SQL查询非常慢，怎么优化这条SQL</p></li><li><p>CPU指标突刺，是什么原因，怎么定位问题</p></li><li><p>系统监控是如何做的，服务日志监控是如何做的，服务告警如何做的</p></li><li><p>服务性能瓶颈是如何定位的，定位后如何提升性能的，高可用要解决的问题是什么，又会带来什么问题</p></li><li><p>服务接口响应慢，如何排查和定位问题</p></li><li><p>为什么引入Redis，引入Redis后做了什么，如何确定哪一块逻辑要用Redis，如果不用Redis可不可以，Redis用的哪一个数据结构</p></li><li><p>服务限流、熔断怎么做的，什么情况下会出现熔断，熔断降级是怎么做的，实现原理是什么</p></li><li><p>如何监控服务接口的QPS</p></li><li><p>链路追踪是如何做的，原理是什么，对于单体应用，如何监控请求链路</p></li><li><p>在xxx项目中，有什么比较不错的设计方案，带来了什么效果</p></li><li><p>平时工作中的主要内容是什么，开发和管理的比例是多少</p></li><li><p>分布式ID生成器设计原理是什么</p></li><li><p>锁是如何实现的，使用的哪种锁</p></li><li><p>为什么设计为单体架构，预计什么时候改为高可用架构</p></li><li><p>主要原理是什么，QPS是多少，吞吐量是多少</p></li><li><p>stringbuffer和stringbuilder的区别</p></li><li><p>ArrayList和linkedlist的区别</p></li><li><p>NIO，select、epoll、poll和reactor</p></li><li><p>时间轮子实现调度</p></li><li><p>JVM调优</p></li><li><p>G1/ZGC的算法，新版jdk对CMS的优化</p></li><li><p>reuseport详解</p></li><li><p>Redis相关的知识点</p></li><li><p>mycat和shardingjdbc场景和区分</p></li><li><p>sdk和proxy的稳定性更新</p></li><li><p>延迟队列的设计</p></li><li><p>时间轮子怎么分流</p></li><li><p>MySQL索引结构为什么不用跳表</p></li><li><p>网关主要功能，如何设计</p></li><li><p>Redis是如何做主从切换的(Sentinel)</p></li><li><p>微信抢红包设计</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;
&lt;p&gt;JVM频繁FGC如何排查，FGC的原因是什么，如何减少FGC&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;怎么查看GC日志，GC日志关注哪些内容，通过这些内容能总结出什么问题&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;spring事务的具体实现是怎么做的，事务为什么会
      
    
    </summary>
    
    
      <category term="杂谈" scheme="http://chuanyichuan.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="面试" scheme="http://chuanyichuan.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>网上po的据说阿里P7的技术点</title>
    <link href="http://chuanyichuan.github.io/2021/05/13/%E7%BD%91%E4%B8%8Apo%E7%9A%84%E6%8D%AE%E8%AF%B4%E9%98%BF%E9%87%8CP7%E7%9A%84%E6%8A%80%E6%9C%AF%E7%82%B9/"/>
    <id>http://chuanyichuan.github.io/2021/05/13/网上po的据说阿里P7的技术点/</id>
    <published>2021-05-13T01:08:00.000Z</published>
    <updated>2021-05-13T01:09:47.578Z</updated>
    
    <content type="html"><![CDATA[<p><strong>常用设计模式</strong></p><ul><li>单例模式：懒汉式、饿汉式、双重校验锁、静态加载，内部类加载、枚举类加载。保证一个类仅有一个实例，并提供一个访问它的全局访问点。</li><li>代理模式：动态代理和静态代理，什么时候使用动态代理。</li><li>适配器模式：将一个类的接口转换成客户希望的另外一个接口。适配器模式使得原本由于接口不兼容而不能一起工作的那些类可以一起工作。</li><li>装饰者模式：动态给类加功能。</li><li>观察者模式：有时被称作发布/订阅模式，观察者模式定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。这个主题对象在状态发生变化时，会通知所有观察者对象，使它们能够自动更新自己。</li><li>策略模式：定义一系列的算法,把它们一个个封装起来, 并且使它们可相互替换。</li><li>外观模式：为子系统中的一组接口提供一个一致的界面，外观模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。</li><li>命令模式：将一个请求封装成一个对象，从而使您可以用不同的请求对客户进行参数化。</li><li>创建者模式：将一个复杂的构建与其表示相分离，使得同样的构建过程可以创建不同的表示。</li><li>抽象工厂模式：提供一个创建一系列相关或相互依赖对象的接口，而无需指定它们具体的类。</li></ul><p><strong>基础知识</strong></p><ul><li>java基本类型哪些，所占字节和范围</li><li>Set、List、Map的区别和联系</li><li>什么时候使用Hashmap</li><li>什么时候使用Linkedhashmap、Concurrenthashmap、Weakhashmap</li><li>哪些集合类是线程安全的</li><li>为什么Set、List、map不实现Cloneable和Serializable接口</li><li>Concurrenthashmap的实现，1.7和1.8的实现</li><li>Arrays.sort的实现</li><li>什么时候使用CopyOnArrayList</li><li>volatile的使用</li><li>synchronied的使用</li><li>reentrantlock的实现和Synchronied的区别</li><li>CAS的实现原理以及问题</li><li>AQS的实现原理</li><li>接口和抽象类的区别，什么时候使用</li><li>类加载机制的步骤，每一步做了什么，static和final修改的成员变量的加载时机</li><li>双亲委派模型</li><li>反射机制：反射动态擦除泛型、反射动态调用方法等</li><li>动态绑定：父类引用指向子类对象</li><li>JVM内存管理机制：有哪些区域，每个区域做了什么</li><li>JVM垃圾回收机制：垃圾回收算法 垃圾回收器 垃圾回收策略</li><li>jvm参数的设置和jvm调优</li><li>什么情况产生年轻代内存溢出、什么情况产生年老代内存溢出</li><li>内部类：静态内部类和匿名内部类的使用和区别</li><li>Redis和memcached：什么时候选择redis，什么时候选择memcached，内存模型和存储策略是什么样的</li><li>MySQL的基本操作 主从数据库一致性维护</li><li>mysql的优化策略有哪些</li><li>mysql索引的实现 B+树的实现原理</li><li>什么情况索引不会命中，会造成全表扫描</li><li>java中bio nio aio的区别和联系</li><li>为什么bio是阻塞的 nio是非阻塞的 nio是模型是什么样的</li><li>Java io的整体架构和使用的设计模式</li><li>Reactor模型和Proactor模型</li><li>http请求报文结构和内容</li><li>http三次握手和四次挥手</li><li>rpc相关：如何设计一个rpc框架，从io模型 传输协议 序列化方式综合考虑</li><li>Linux命令 统计，排序，前几问题等</li><li>StringBuff 和StringBuilder的实现，底层实现是通过byte数据，外加数组的拷贝来实现的</li><li>cas操作的使用</li><li>内存缓存和数据库的一致性同步实现</li><li>微服务的优缺点</li><li>线程池的参数问题</li><li>ip问题 如何判断ip是否在多个ip段中</li><li>判断数组两个中任意两个数之和是否为给定的值</li><li>乐观锁和悲观锁的实现</li><li>synchronized实现原理</li><li>你在项目中遇到的困难和怎么解决的</li><li>你在项目中完成的比较出色的亮点</li><li>消息队列广播模式和发布/订阅模式的区别</li><li>生产者消费者代码实现</li><li>死锁代码实现</li><li>线程池：参数，每个参数的作用，几种不同线程池的比较，阻塞队列的使用，拒绝策略</li><li>Future和ListenableFuture 异步回调相关</li><li>算法相关：判断能否从数组中找出两个数字和为给定值，随机生成1~10000不重复并放入数组，求数组的子数组的最大和，二分查找算法的实现及其时间复杂计算</li></ul><p><strong>其他</strong></p><ul><li>算法：常用排序算法，二分查找，链表相关，数组相关，字符串相关，树相关等</li><li>常见序列化协议及其优缺点</li><li>memcached内存原理，为什么是基于块的存储</li><li>搭建一个rpc需要准备什么</li><li>如果线上服务器频繁地出现full gc ，如何去排查</li><li>如果某一时刻线上机器突然量变得很大，服务扛不住了，怎么解决</li><li>LUR算法的实现</li><li>LinkedHashMap实现LRU</li><li>定义栈的数据结构，请在该类型中实现一个能够找到栈最小元素的min函数</li><li>海量数据处理的解决思路</li><li>reactor模型的演变</li><li>阻塞、非阻塞、同步、异步区别</li><li>Collection的子接口</li><li>jvm调优相关</li><li>zookeeper相关，节点类型，如何实现服务发现和服务注册</li><li>nginx负载均衡相关，让你去实现负载均衡，该怎么实现</li><li>linux命令，awk、cat、sort、cut、grep、uniq、wc、top等</li><li>压力测试相关，怎么分析，单接口压测和多情况下的压测</li><li>你觉得你的有点是什么，你的缺点是什么</li><li>spring mvc的实现原理</li><li>netty底层实现，IO模型，ChannelPipeline的实现和原理</li><li>缓存的设计和优化</li><li>缓存和数据库一致性同步解决方案</li><li>你所在项目的系统架构，谈谈整体实现</li><li>消息队列的使用场景</li><li>ActiveMQ、RabbitMQ、Kafka的区别</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;常用设计模式&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;单例模式：懒汉式、饿汉式、双重校验锁、静态加载，内部类加载、枚举类加载。保证一个类仅有一个实例，并提供一个访问它的全局访问点。&lt;/li&gt;
&lt;li&gt;代理模式：动态代理和静态代理，什么时候使用动态代理。&lt;
      
    
    </summary>
    
    
      <category term="杂谈" scheme="http://chuanyichuan.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="面试" scheme="http://chuanyichuan.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
      <category term="阿里" scheme="http://chuanyichuan.github.io/tags/%E9%98%BF%E9%87%8C/"/>
    
  </entry>
  
  <entry>
    <title>发布jar到Maven中央仓库报错:Remote-Staging-Failed-Staging-Rules-Failure!</title>
    <link href="http://chuanyichuan.github.io/2021/05/12/%E5%8F%91%E5%B8%83jar%E5%88%B0Maven%E4%B8%AD%E5%A4%AE%E4%BB%93%E5%BA%93%E6%8A%A5%E9%94%99Remote-staging-failed-Staging-rules-failure!/"/>
    <id>http://chuanyichuan.github.io/2021/05/12/发布jar到Maven中央仓库报错Remote-staging-failed-Staging-rules-failure!/</id>
    <published>2021-05-12T15:32:00.000Z</published>
    <updated>2021-05-22T15:34:28.827Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>发布Jar到中央仓库报错 Remote staging failed: Staging rules failure!<br>意思是：<br>未遵守发布jar的规则，可以查看命令行中详细的错误描述【error】…<br>如果是手动发布，即在https://oss.sonatype.org/网址上发布的，可以点开页面下方的日志列表，查看错误描述。</p></blockquote><p><strong>提示：No public key: Key with id: (51xxxxxxc6) was not able to be located on</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver hkp://pool.sks-keyservers.net:11371 --send-keys  1982**************7F80B</span><br><span class="line">gpg --keyserver hkp://pool.sks-keyservers.net:11371 --recv-keys  1982**************7F80B</span><br><span class="line"></span><br><span class="line">gpg --keyserver hkp://keyserver.ubuntu.com:11371 --send-keys  1982**************7F80B</span><br><span class="line">gpg --keyserver hkp://keyserver.ubuntu.com:11371 --recv-keys  1982**************7F80B</span><br><span class="line"></span><br><span class="line">gpg --keyserver hkp://keys.gnupg.net:11371 --send-keys  1982**************7F80B</span><br><span class="line">gpg --keyserver hkp://keys.gnupg.net:11371 --recv-keys  1982**************7F80B</span><br></pre></td></tr></table></figure><p>解决！！！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;发布Jar到中央仓库报错 Remote staging failed: Staging rules failure!&lt;br&gt;
意思是：&lt;br&gt;
未遵守发布jar的规则，可以查看命令行中详细的错误描述【error】…&lt;br&gt;
如果是手动发布，即在ht
      
    
    </summary>
    
    
      <category term="Maven" scheme="http://chuanyichuan.github.io/categories/Maven/"/>
    
    
  </entry>
  
  <entry>
    <title>记一次线上JVM优化</title>
    <link href="http://chuanyichuan.github.io/2021/05/09/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8AJVM%E4%BC%98%E5%8C%96/"/>
    <id>http://chuanyichuan.github.io/2021/05/09/记一次线上JVM优化/</id>
    <published>2021-05-09T03:50:00.000Z</published>
    <updated>2021-05-09T09:54:12.905Z</updated>
    
    <content type="html"><![CDATA[<p>夜黑风高的周末夜晚，正躲在书房追剧刘老根4，突然手机开始震个不停，心想难道是我的比特币要炸了吗？慌忙拿起手机的那一刻突然想起来我好像买不起比特币(心凉半截)，原来是在公司群里被人艾特了，原来是S部门的某个Java服务出现了性能问题，找我这个Z部门的人帮忙看一下，描述是这样的：</p><blockquote><p>白天的时候jvm涨的快，gc的几秒就完成了</p><p>到了晚上低峰期，jvm会涨的非常慢，但是一旦满了，就需要一两分钟时间进行gc，所以每隔一大段时间，会卡住一两分钟</p></blockquote><p>一次GC需要一两分钟的时间，最快的时候也需要几秒钟，心里一紧，这是个大活啊，我们知道每一次GC都会引起STW，STW基本在毫秒级是正常的，他们最快也到了秒级，那就是如果平均十秒钟进行一次GC，每次3秒钟，那么一分钟就要消耗18秒的时间用于GC回收，服务时间只有可怜的43秒，秒算一下吞吐量就是<code>42/60≈0.7</code>，这个吞吐量简直太低了。既然说了GC的问题，那么我就只能先从GC日志入手了，对方突然告诉我没有gc日志，纳尼？没有GC日志那如何分析具体情况，通过GC日志排查问题的路子貌似走不通了，那就换一种思路，看一下JVM堆内存的分配情况，对方突然又告诉我堆大小设置了100G，哈哈…抓紧跑到厨房开了一罐冰镇雪花一饮而尽压一下任督二脉，然后让对方把JVM堆的详细信息以及启动时JVM配置发过来：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 35123101696 (33496.0MB)</span><br><span class="line">   used     = 16283632872 (15529.282447814941MB)</span><br><span class="line">   free     = 18839468824 (17966.71755218506MB)</span><br><span class="line">   46.36160272216068% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 241172480 (230.0MB)</span><br><span class="line">   used     = 241098984 (229.9299087524414MB)</span><br><span class="line">   free     = 73496 (0.07009124755859375MB)</span><br><span class="line">   99.96952554453974% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 338165760 (322.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 338165760 (322.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 14133231616 (13478.5MB)</span><br><span class="line">   used     = 11079132696 (10565.884300231934MB)</span><br><span class="line">   free     = 3054098920 (2912.6156997680664MB)</span><br><span class="line">   78.39065400624649% used</span><br></pre></td></tr></table></figure><p>这个可以通过JVM的<code>jmap -heap</code>命令得到，详细操作就不做说明了，通过堆的信息，我做了几个假设：</p><ol><li>Eden区较大，每次Minor GC时待标记的对象较多</li><li>Survivor区空间较小，Minor GC后无法容纳仍存活对象，导致对象过早的进入到老年代，致使老年代空间不足</li><li>老年代空间不足，导致频繁发生FGC</li><li>堆空间过大，每次FGC做标记时，待标记的对象较多</li></ol><p>刚分析好，就又收到了JVM启动配置，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-XX:CICompilerCount=15</span><br><span class="line">-XX:InitialHeapSize=2147483648(2G)</span><br><span class="line">-XX:MaxHeapSize=107374182400(100G)</span><br><span class="line">-XX:MaxNewSize=35791044608(34G)</span><br><span class="line">-XX:MinHeapDeltaBytes=524288(512k)</span><br><span class="line">-XX:NewSize=715653120(682.5m)</span><br><span class="line">-XX:OldSize=1431830528(1.333G)</span><br><span class="line">-XX:+UseParallelGC</span><br><span class="line">-XX:ParallelGCThreads=38</span><br><span class="line">-Xmx100g</span><br></pre></td></tr></table></figure><p>从启动配置上得出了<code>Young</code>和<code>Old</code>的比例是默认的<code>1:2</code>，以及<code>Eden</code>和<code>Survivor</code>的比例是默认的<code>8:1:1</code>，新生代使用的是<code>Parallel Scoverage</code>垃圾收集器，那么对应的老年代就是<code>Parallel Old</code>垃圾收集器(jdk1.8版本)，并发线程是38，服务器是322G40C的配置，这些参数都没什么问题，从上面堆的信息能够看到在新生代中，<code>Eden</code>和<code>Survivor</code>的比例并不是按照<code>8:1:1</code>来分配的，<code>Eden</code>区很明显高于<code>Survivor</code>区太多，这是因为在实际运行过程中JVM对整体堆内存分配做了自适应，它认为太多的对象在第一次<code>Minor GC</code>的时候就会被回收，所以就加大了<code>Eden</code>区的大小，但是这种配置就会出现了一个问题：当某一次Minor GC时候，<code>Eden</code>区仍有一半的对象存活，但此时整个<code>Young</code>区的空间都被<code>Eden</code>区霸占了，<code>Survivor</code>区已经申请不到更多的内存，这就会造成很多存活的对象直接进入到老年代中，迅速占领老年代的空间，然后发生<code>FGC</code>。</p><p>简单问了一下S部门的同学为什么将堆设置到100G，给我的回答是：一开始是设置的20G，但是经常有人反馈服务响应较慢，所以就调整到了50G，结果运行一段时间后还被反馈响应较慢，然后就调到了100G，正准备调成150G呢，结果被告知来找我们帮忙。我推测是不是在设置为20G的时候出现了OOM，所以才想的提升堆的内存，然后他们告诉我并没有发生OOM，这也就是说其实堆内存在20G的时候是够用的，性能之所以拉跨，是因为分代内存设置的不合理，导致出现了过多的FGC，而FGC之后，堆又释放了很多空间，于是我推断大多数对象的存活周期都比较短，是因为Survivor区较小导致他们进入到了老年代，然后在FGC的时候被回收掉。</p><p>这么分析下来，证明了我上面所做的假设全部正确，既然问题出在堆空间分配上，我就重新来做一次分配吧：把堆最大内存设置为30G，并且通过<code>-Xmx</code>和<code>-Xms</code>让堆在初始化时就向系统申请30G的空间，然后通过<code>-Xmn</code>指定新生代的大小为18G，并且调整<code>Eden</code>和<code>Survivor</code>区的比例为<code>2:1:1</code>，让对象在<code>Minor GC</code>阶段就被回收掉，垃圾收集器由并行的<code>Parallel</code>修改为新生代使用<code>ParNew</code>、老年代使用<code>CMS</code>，完整的配置如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-Xms30g</span><br><span class="line">-Xmx30g</span><br><span class="line">-Xmn18g</span><br><span class="line">-XX:SurvivorRatio=2</span><br><span class="line">-XX:+UseParNewGC</span><br><span class="line">-XX:ParallelGCThreads=38</span><br><span class="line">-XX:+UseConcMarkSweepGC</span><br><span class="line">-XX:+UseCMSCompactAtFullCollection</span><br><span class="line">-XX:CMSFullGCsBeforeCompaction=10</span><br><span class="line">-XX:+PrintGC</span><br><span class="line">-XX:+PrintGCDetails</span><br><span class="line">-XX:+PrintGCTimeStamps</span><br><span class="line">-Xloggc:/root/gclogs/gc.log</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:HeapDumpPath=/root/gclogs/gerrit_heap.dump</span><br></pre></td></tr></table></figure><p>重启服务之后配置生效，使用<code>jmap</code>检查下堆内存是否有按照我们设置的进行分配：</p><img src="/images/image-20210509153722031.png" alt="image-20210509153722031" style="zoom:50%;"><p>完美，说明我们的设置已经生效了，那么接下来就是监控GC的情况了，在服务运行了12个小时之后，捞出GC日志，这里贴一下最近的几条GC日志</p><img src="/images/image-20210509155037775.png" alt="image-20210509155037775" style="zoom:50%;"><p>GC日志告诉我们从37295到46560这9265秒(2.5h)内，均未发生FGC，并且YGC的时间也很好的控制在了毫秒级，虽然还是有点高，但毕竟我们使用的堆内存较大，这个量级已经算是还不错了。算下来每次进入到老年代的对象在几十~几千kb，虽然也挺多，但堆内存较大，还在容忍范围内。</p><p>既然看了GC，那我们也就顺道看一下当前的堆内存使用情况：</p><img src="/images/image-20210509162946346.png" alt="image-20210509162946346" style="zoom:67%;"><p>在没有发生FGC的情况下，老年代使用了19.4215%的空间，新生代的Eden区使用了4.4556%的空间，Survivor区使用了3.724548%，看样子还挺不错的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;夜黑风高的周末夜晚，正躲在书房追剧刘老根4，突然手机开始震个不停，心想难道是我的比特币要炸了吗？慌忙拿起手机的那一刻突然想起来我好像买不起比特币(心凉半截)，原来是在公司群里被人艾特了，原来是S部门的某个Java服务出现了性能问题，找我这个Z部门的人帮忙看一下，描述是这样的
      
    
    </summary>
    
    
      <category term="Java" scheme="http://chuanyichuan.github.io/categories/Java/"/>
    
    
      <category term="JVM" scheme="http://chuanyichuan.github.io/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Redis知识体系整理</title>
    <link href="http://chuanyichuan.github.io/2021/04/30/Redis%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E6%95%B4%E7%90%86/"/>
    <id>http://chuanyichuan.github.io/2021/04/30/Redis知识体系整理/</id>
    <published>2021-04-30T02:00:00.000Z</published>
    <updated>2021-04-30T02:57:13.902Z</updated>
    
    <content type="html"><![CDATA[<p>个人理解的简单整理，若有误请不吝指正。</p><p>如果图不清晰，可以关注公众号获取：cyc_java，回复：Redis</p><p><img src="/images/Redis%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png" alt="Redis知识体系"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;个人理解的简单整理，若有误请不吝指正。&lt;/p&gt;
&lt;p&gt;如果图不清晰，可以关注公众号获取：cyc_java，回复：Redis&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/Redis%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png&quot; alt
      
    
    </summary>
    
    
      <category term="Redis" scheme="http://chuanyichuan.github.io/categories/Redis/"/>
    
    
  </entry>
  
  <entry>
    <title>共识算法知识体系</title>
    <link href="http://chuanyichuan.github.io/2021/04/30/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/"/>
    <id>http://chuanyichuan.github.io/2021/04/30/共识算法知识体系/</id>
    <published>2021-04-30T01:00:00.000Z</published>
    <updated>2021-04-30T02:57:16.098Z</updated>
    
    <content type="html"><![CDATA[<p>个人理解的简单整理，若有误请不吝指正</p><p><img src="/images/Paxos_Raft_Base%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png" alt="Paxos_Raft_Base知识体系"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;个人理解的简单整理，若有误请不吝指正&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/Paxos_Raft_Base%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB.png&quot; alt=&quot;Paxos_Raft_Base知识体系&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="分布式" scheme="http://chuanyichuan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
  </entry>
  
  <entry>
    <title>锁在事务中的释放</title>
    <link href="http://chuanyichuan.github.io/2021/04/29/%E9%94%81%E5%9C%A8%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84%E9%87%8A%E6%94%BE%E6%97%B6%E6%9C%BA/"/>
    <id>http://chuanyichuan.github.io/2021/04/29/锁在事务中的释放时机/</id>
    <published>2021-04-29T01:05:00.000Z</published>
    <updated>2021-05-09T11:01:50.727Z</updated>
    
    <content type="html"><![CDATA[<p>锁在开发过程中属于是比较常见的一种保证资源互斥的手段，常用的手段一般就是加锁、设置超时时间、过期释放、手动释放，对应的伪代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>:</span></span><br><span class="line"><span class="function">   <span class="title">if</span> !<span class="title">lock</span>.<span class="title">lock</span>(<span class="params">key, timeout</span>):</span></span><br><span class="line"><span class="function">     <span class="title">return</span></span></span><br><span class="line"><span class="function">   <span class="title">try</span>:</span></span><br><span class="line"><span class="function">     <span class="title">doBusiness</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   <span class="title">exception</span>:</span></span><br><span class="line"><span class="function">     <span class="title">doException</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   <span class="title">finally</span>:</span></span><br><span class="line"><span class="function">     <span class="title">lock</span>.<span class="title">release</span>(<span class="params">key</span>)</span></span><br></pre></td></tr></table></figure><p>伪代码应该没有问题，有同学说<code>lock.lock(key, timeout)</code>应该放到<code>try</code>里面，其实这里呢觉得不太适合，业务如果加锁出现了异常，方法就直接结束了，放到<code>try</code>中的话，出现了异常依然会走到<code>finally</code>中去释放锁，如果在释放锁之前有别的业务抢到了锁，那么这时候就被提前释放掉了，大致图解如下：</p><img src="/images/image-20210429093500721.png" alt="image-20210429093500721" style="zoom:50%;"><p>从图示可以看到线程B的锁被线程A给释放掉了，此时线程C抢占锁时能够顺利的加锁成功，结果就是造成线程B和线程C的数据出现了异常，所以<code>lock.lock(key, timeout)</code>申请锁的语句不应和释放锁在同一个<code>try...catch...finally</code>中的原因就不明而厉了。</p><p>既然说到了加锁，现在我们再来说说释放锁，释放锁分为自动释放和主动释放，自动释放就是非人为的释放，作为一名合格的开发人员，大家都知道在加锁时会给锁设置一个过期时间，超过这个时间之后锁自动释放，目的也很明确：</p><ol><li>为了防止手动释放锁时因系统crash而造成的锁释放失败导致锁长期持有的情况；</li><li>一旦锁无法及时释放，那么后续的请求将全部无法成功加锁，业务将无法正常进行</li><li>图解如下：</li></ol><img src="/images/image-20210429094814276.png" alt="image-20210429094814276" style="zoom:50%;"><p>图示线程A加锁成功但锁未释放，导致后续的线程B和线程C，乃至线程n都抢占不到锁，这将是一个非常严重的产线事故，不得了不得了。</p><p>很多文章都说应该在<code>finally</code>代码块中释放锁，因为不论<code>try</code>中代码执行是否出现异常，<code>finally</code>代码块都必定会被执行，通过上面加锁代码分析知道只有抢到锁的线程才能执行到<code>try</code>中，所以在<code>finally</code>中处理锁释放逻辑无可厚非，但是现在有一个新的问题：如果该方法是有<code>事务</code>的方法，在锁释放的时候，事务还没有提交，我们再来看张图(图有点多，但是清晰)：</p><img src="/images/image-20210429105852689.png" alt="image-20210429105852689" style="zoom:50%;"><p>两个线程执行之后，age的值是2，并不是预期的3，是不是就出现了脏数据，并且脏的还不一般。所以正常的处理流程应该是先提交事务再释放锁，那么我们来想一想应该怎么做才能让事务先提交，锁后释放。</p><ol><li>使用<code>scheduler</code>线程池延迟释放锁</li><li>使用<code>AOP</code>织入释放</li><li>使用<code>TransactionSynchronizationAdapter</code>监听释放</li></ol><p>前两种大家应该很容易就想到如何实现，那就不做太多的解释了，不说又有点不负责任的样子，还是唠唠吧。。</p><blockquote><p>有一个<code>LockProcessor</code>类，在文章最后</p></blockquote><h4 id="1-锁延迟释放"><a class="markdownIt-Anchor" href="#1-锁延迟释放"></a> 1. 锁延迟释放</h4><p>锁延迟释放，是一个不错的方法，但还是没那么的完美，关键点在延迟多久释放锁，如果延迟3秒释放，那么其他线程又白白多等了3秒，但若是延迟100ms，仍然会发生锁在事务提交之前释放的情况。</p><ul><li><p>首先我们要定义一个<code>ScheduledThreadPoolExecutor</code>线程池来执行所释放的任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowmanScheduledExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledThreadPoolExecutor EXECUTOR = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">10</span>, r -&gt; &#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">        thread.setName(<span class="string">"lock release executor threadId - "</span> + thread.getId());</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    &#125;, <span class="keyword">new</span> ThreadPoolExecutor.DiscardPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * accept runnable job</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.execute(runnable, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable, <span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.execute(runnable, delayTime, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable runnable, <span class="keyword">long</span> delayTime, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        EXECUTOR.schedule(runnable, delayTime, unit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在<code>finally</code>中将释放锁放入到线程池中静等释放</p><p>在业务代码中，直接使用该类即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> SnowmanScheduledExecutor snowmanScheduledExecutor;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generate</span><span class="params">(String lock_key)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// acquire lock</span></span><br><span class="line">      <span class="keyword">int</span> lockTimes = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (!lock.tryLock(groupCode, Constants.DEFAULT_TIMEOUT)) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (lockTimes++ &gt; <span class="number">3</span>) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> CannotAcquireLockException(<span class="string">"acquire lock timeout!"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          doBusiness();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          log.error(<span class="string">"generate error!"</span>, e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          snowmanScheduledExecutor.execute(() -&gt; &#123;</span><br><span class="line">              lock.releaseLock(groupCode);</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>并发测试</p><p>我们使用jmeter进行测试，开启100个线程循环10次。这里不贴图了，采用了默认的100ms作为延迟释放时间，除了吞吐量低了点，但未产生脏数据。不过虽然没有产生脏数据，但吞吐量是在高并发环境下很重要的一个指标，以降低吞吐量来达到数据一致性的方法好像也不是最优的。</p></li></ul><p>####2. AOP织入释放</p><p>既然通过延迟释放不能近乎完美的解决锁释放的问题，那么通过AOP是否可以呢？我们知道AOP实际上就是通过代理的方式给类和方法添加一些额外的操作，如果我们在进入业务方法之前申请锁，在业务方法返回之后提交事务，然后在AOP中释放锁，是不是就能完美的解决了？试一下看看。</p><ul><li><p>编写AOP代理类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.CannotAcquireLockException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.DefaultTransactionDefinition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cc.bert.lt.config.Constants;</span><br><span class="line"><span class="keyword">import</span> cc.bert.lt.utils.LockProcessor;</span><br><span class="line"><span class="keyword">import</span> cc.bert.lt.utils.TransactionUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockAdvise</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LockProcessor                lockProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TransactionUtils             transactionUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultTransactionDefinition definition;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * cc.bert.lt.service.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">LockAdvise</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        definition = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">        definition.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"LockAdvise()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">lock</span><span class="params">(ProceedingJoinPoint point)</span> </span>&#123;</span><br><span class="line">        TransactionStatus status = transactionUtils.begin(definition);</span><br><span class="line"></span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes())</span><br><span class="line">                .getRequest();</span><br><span class="line">        Map pathVariables = (Map) request.getAttribute(HandlerMapping.URI_TEMPLATE_VARIABLES_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">        String groupCode = String.valueOf(pathVariables.get(<span class="string">"code"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// acquire lock</span></span><br><span class="line">        Object obj = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> lockTimes = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (!lockProcessor.tryLock(groupCode, Constants.DEFAULT_TIMEOUT)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lockTimes++ &gt; <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> CannotAcquireLockException(<span class="string">"acquire lock timeout!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            obj = point.proceed();</span><br><span class="line">            transactionUtils.commit(status);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            log.error(<span class="string">"occur ex: "</span>, throwable);</span><br><span class="line">            transactionUtils.rollback(status);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lockProcessor.releaseLock(groupCode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>TransactionUtils类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.bert.lt.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.TransactionStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.support.DefaultTransactionDefinition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"code_transaction"</span>)</span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager platformTransactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TransactionStatus <span class="title">begin</span><span class="params">(DefaultTransactionDefinition definition)</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"start transaction!"</span>);</span><br><span class="line">        <span class="keyword">return</span> platformTransactionManager.getTransaction(definition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">        platformTransactionManager.commit(status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">        platformTransactionManager.rollback(status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>上面的代码都不需要做过多的解释，很简单，但是有一点需要注意的就是被代理方法上不能出现<code>@Transactional</code>注解</p><h4 id="3-transactionsynchronizationadapter释放"><a class="markdownIt-Anchor" href="#3-transactionsynchronizationadapter释放"></a> 3. <code>TransactionSynchronizationAdapter</code>释放</h4><p>这是一个比较推荐的方式，使用起来也比较简单，只需要在业务方法的finally中加入一句代码即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听器释放</span></span><br><span class="line">TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> TransactionSynchronizationAdapter() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    lockProcessor.releaseLock(groupCode);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>也可以实现一个<code>TransactionSynchronizationAdapter</code>子类来做，条条大路通罗马。</p><hr><blockquote><p>LockProcessor</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.bert.lt.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cc.bert.lt.config.Constants;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chuan</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * groupCode cache set</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Set&lt;String&gt; groupCodeSet = <span class="keyword">new</span> ConcurrentHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * release lock</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupCode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">releaseLock</span><span class="params">(String groupCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> groupCodeSet.remove(groupCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * try to lock the group</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout unit: ms</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String groupCode, <span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">            timeout = Constants.DEFAULT_TIMEOUT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">while</span> ((System.currentTimeMillis() - startTime) &lt; timeout) &#123;</span><br><span class="line">            <span class="keyword">if</span> (groupCodeSet.add(groupCode)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;锁在开发过程中属于是比较常见的一种保证资源互斥的手段，常用的手段一般就是加锁、设置超时时间、过期释放、手动释放，对应的伪代码：&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;p
      
    
    </summary>
    
    
      <category term="Spring" scheme="http://chuanyichuan.github.io/categories/Spring/"/>
    
    
      <category term="锁" scheme="http://chuanyichuan.github.io/tags/%E9%94%81/"/>
    
      <category term="分布式锁" scheme="http://chuanyichuan.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    
      <category term="事务" scheme="http://chuanyichuan.github.io/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>面试记录(面试官角色)</title>
    <link href="http://chuanyichuan.github.io/2021/04/20/%E9%9D%A2%E8%AF%95%E8%AE%B0%E5%BD%95%E4%B8%80/"/>
    <id>http://chuanyichuan.github.io/2021/04/20/面试记录一/</id>
    <published>2021-04-20T14:39:00.000Z</published>
    <updated>2021-07-15T01:13:58.763Z</updated>
    
    <content type="html"><![CDATA[<ol><li>数据pull模式，多久调用一次，这个时间是通过什么因素来抉择出来的，调用失败了如何补偿，补偿的机制是什么</li><li>集群部署策略是什么，集群运行状态如何监控，数据怎么采集的，采集后的存储和分析策略是什么</li><li>Nacos用来做注册中心的话，它是怎么贴合CAP理论的，C/A切换是怎么做的，配置属性是如何实现动态刷新的</li><li>你们项目的质量因素有哪些，模块之间划分的依据是什么，C&amp;C是怎么设计的</li><li>项目峰值几万人：QPS和TPS是多少，有没有遇到过性能瓶颈，遇到性能瓶颈的告警机制是怎么设置的，流量激增的时候怎么自动扩容的</li><li>CPU、Memory、Load过高是如何监控、排查、修复的，遇到僵尸进程是如何处理的</li><li>单体项目、有容器、用的ssh：容器怎么进行管理的，高可用怎么做的</li><li>客户端多类、json通信：网关层怎么做的，怎么根据客户端类型做的转发，DDoS攻击怎么预防的</li><li>数据库：用的什么架构，读写分离是怎么做的，主从切换是怎么切换的，切换之后VIP漂移是怎么做的</li></ol><p>1.eureka如何处理高并发读写<br>2.mysql行锁没有释放怎么处理<br>3.AQS底层是什么<br>4.new一个对象，几种内存分配方式<br>5.线程池有哪几种实现方式<br>6.netty的channel生命周期是怎么样的<br>7.springcloud gateway实现原理，画图出来<br>8.1234567  7个数字  分别用二叉树 平衡二叉树  b树  b+树  画图出来<br>9.mysql读写分离，从库没有同步主库的数据原因有哪些<br>10.G1收集器与CMS收集器三色回收算法的区别是什么<br>11.G1收集器与CMS收集器的区别在哪里<br>12.hystris原理（动态代理）<br>13.inodb和mysiam的区别<br>14.spring哪几种注入方式<br>15.mybatis一对一，一对多标签分别是啥？<br>16.线程的底层是什么</p><ol><li>MySQL源码看过吗</li><li>InnoDB存储引擎底层是如何实现的</li><li>MVCC的隐藏列是如何添加的，是持久化到磁盘上的，还是存于内存中的</li><li>InnoDB是通过什么方式加的行级锁</li><li>myisam为什么不支持行级锁，如果想让myisam支持行锁，应该怎么做</li><li>idb的存储结构是什么样子的，为什么表数据量过大会影响效率</li><li>一个区内的页，在磁盘上是如何存储的，区的大小是固定的吗？</li><li>当页发生分裂或合并时，大小会改变吗，会变换所在区吗</li></ol><p>重构升级：如何重构，重构的原因是什么，扩展性差、代码难维护、*业务耦合度高、数据库设计乱、表重复设计较多、SQL效率较低<br>API网关、灰度发布、任务调度：设计架构是什么<br>技术组件开发：比如？</p><p>if…else：策略模式、工厂模式</p><p>多客户端<br>bff层——&gt;dubbo——&gt;provider/consumer</p><p>MQ用的什么，补偿机制是怎么设计的</p><p>MySQL</p><p>模块：行程、计费、订单、支付、通用</p><p>技术选型：学习成本较高</p><p>表主键：雪花ID<br>城市ID_业务场景code_商户ID_雪花ID</p><p>新旧系统并行运行：怎么做的灰度<br>全路由：路由是怎么设计的，映射是如何做的，枚举值映射是指什么？值域有哪些？硬编码写在代码中？如果重新设计，这块有没有好的方案<br>单体架构——&gt;微服务SpringCloud：服务治理是如何做的，高可用是如何保证的，服务注册中心使用的zk，zk的master节点宕机后，服务会产生暂时的不可用，这个是如何解决的？<br>修改期间可以灰度上线，为什么会出现服务不可用？拆分服务如何确定各模块的质量元素？模块之间通信是如何设计的，二方包如何管理的？<br>nginx做负载，负载策略是什么？nginx有哪些负载策略，使用的场景是什么？ip-hash解决了什么问题，又会遇到什么问题，如何解决问题？<br>zk分布式锁：与Redis分布式锁的区别是什么？各自的优劣是什么？如果业务尚未执行完，Redis锁已经过期了，怎么解决？zk的分布式锁使用的队列设计原则是什么？为了解决什么问题？zk的存储结构是什么<br>zk的临时节点和持久节点的创建方式是什么？如何预防zk的脑裂？</p><p>MySQL：<br>MySQL的默认事务隔离级别是什么？<br>MySQL的exists和in的使用场景是什么？<br>select for update是什么锁？<br>有没有做过分库分表？mycat的ER表是如何设计的？分布式ID如何设计的？<br>索引建立的原则是什么？</p><p>有做过什么优化吗？<br>JVM的堆大小设置的依据是什么？GC的safepoint是如何确定的？<br>GC对Java的软引用有什么影响？在jdk中使用软引用的场景是什么？ThreadLocal的原理是什么？ThreadLocal的默认桶大小为多少，为什么为16？什么情况下会使用到2个以上的桶？<br>在Java中创建一个对象的流程是什么？说的越详细越好</p><p>Maven：<br>Maven依赖冲突是如何解决的？依赖冲突的时候会造成什么影响<br>如何查看某个jar包来自于哪一个依赖？<br>如何约束依赖的全局版本？</p><p>MQ：<br>Kafka如何保证消息顺序消费、在consumer group 中新增一个consumer 会提高消费消息的速度吗、那如果我想提高消息消费的速度，我要怎么办？<br>kafka的零拷贝的原理是什么？mmap和sendfile是如何工作的？</p><p>Docker：<br>Docker镜像是如何制作的，存储于哪里？当一个镜像过大时，如何做的优化？<br>容器伸缩是如何实现的？<br>Docker如何让一个容器状态永久处于UP？如果在Dockerfile中RUN了一个sleep命令，容器的状态变化是什么？</p><p>k8s：<br>service、pod、deployment等的区别是什么</p><ol><li>CMS和G1的异同<br>CMS是老年代的并发垃圾收集器，执行过程是初始标记-STW-并发标记-STW-再次标记-清理，CMS会有两次STW，并且使用的是标记-清理算法，时间久之会产生过多的内存碎片，所以一般会和具有整理功能的Serial Old收集器一起使用，CMS负责清理，Serial Old负责整理，而G1属于整堆收集器，将内存划分为大小相同的region，</li><li>G1什么时候引发FGC</li><li>说一个最熟悉的垃圾回收算法<br>垃圾回收算法有复制、标记-清理、标记-整理、分代算法等，复制算法相对来说比较浪费堆空间，所谓的浪费，</li><li>怎么判断内存泄漏</li><li>讲一下CMS的流程</li><li>为什么压缩指针超过32G失效</li><li>什么是内存泄漏？GC调优有经验吗？一般出现GC问题你怎么解决？</li><li>ThreadLocal有没有内存泄漏问题</li><li>G1两个Region不是连续的，而且之间还有可达的引用，我现在要回收一个，另一个怎么处理</li><li>吞吐量优先和响应时间优先的回收器有哪些</li><li>讲一下JVM堆内存管理（对象分配过程）</li><li>CMS的并发预处理和并发可中断预处理</li><li>到底多大的内存会被直接放到老年代</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;数据pull模式，多久调用一次，这个时间是通过什么因素来抉择出来的，调用失败了如何补偿，补偿的机制是什么&lt;/li&gt;
&lt;li&gt;集群部署策略是什么，集群运行状态如何监控，数据怎么采集的，采集后的存储和分析策略是什么&lt;/li&gt;
&lt;li&gt;Nacos用来做注册中心的话，它
      
    
    </summary>
    
    
      <category term="杂谈" scheme="http://chuanyichuan.github.io/categories/%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="面试" scheme="http://chuanyichuan.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Seata分布式事务(AT模式)粗讲</title>
    <link href="http://chuanyichuan.github.io/2021/04/20/seata%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1(AT%E6%A8%A1%E5%BC%8F)%E5%BA%94%E7%94%A8/"/>
    <id>http://chuanyichuan.github.io/2021/04/20/seata 分布式事务(AT模式)应用/</id>
    <published>2021-04-20T12:00:00.000Z</published>
    <updated>2021-04-20T13:50:21.666Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1nacos服务"><a class="markdownIt-Anchor" href="#1nacos服务"></a> 1.nacos服务</h3><blockquote><ol><li>下载 <a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">nacos-server</a> 服务</li></ol></blockquote><blockquote><ol start="2"><li>解压文件后进入到bin目录运行命令 <code>startup.cmd -m standalone</code>启动nacos服务</li></ol></blockquote><h3 id="2seata服务"><a class="markdownIt-Anchor" href="#2seata服务"></a> 2.seata服务</h3><blockquote><ol><li>下载 <a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener">seata-server</a> 服务</li><li>nacos 服务中创建<code>seata</code>命令空间(ps:命名空间ID定义为seata)</li></ol></blockquote><blockquote><ol start="3"><li>通过脚本 <a href="https://github.com/seata/seata/blob/develop/script/config-center/nacos/nacos-config.sh" target="_blank" rel="noopener">nacos-config.sh</a> 将配置文件<code>config.txt</code>以key作为配置ID，value为文本的配置导入nacos的seata命名空间。配置内容如下：</li></ol></blockquote><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># seata 客户端配置 (ps:seata-text 是事务分组名称可以修改，但是要与服务端tx-service-group值对应,seata 是seata服务集群的名称)</span></span><br><span class="line"><span class="meta">service.vgroupMapping.seata-text</span>=<span class="string">seata</span></span><br><span class="line"><span class="comment"># seata 服务存储配置</span></span><br><span class="line"><span class="meta">store.mode</span>=<span class="string">db</span></span><br><span class="line"><span class="meta">store.db.datasource</span>=<span class="string">druid</span></span><br><span class="line"><span class="meta">store.db.dbType</span>=<span class="string">mysql</span></span><br><span class="line"><span class="meta">store.db.driverClassName</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">store.db.url</span>=<span class="string">jdbc:mysql://xxx.xxx.xxx.xxx:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span></span><br><span class="line"><span class="meta">store.db.user</span>=<span class="string">username</span></span><br><span class="line"><span class="meta">store.db.password</span>=<span class="string">password</span></span><br></pre></td></tr></table></figure><blockquote><p>ps: 数据库的地址、用户名和密码按步骤3配置的信息修改，仓库名默认<code>seata</code>。使用命令<code>sh nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -t seata -u nacos -w nacos</code><br><a href="https://seata.io/zh-cn/docs/user/configurations.html" target="_blank" rel="noopener">配置</a>将配置导入 nacos 服务中</p></blockquote><blockquote><ol start="4"><li>修改<code>seata</code>服务<code>conf</code>目录下的<code>registry.conf</code>文件内容如下:</li></ol></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span></span><br><span class="line">  type = "nacos"</span><br><span class="line">  loadBalance = "RandomLoadBalance"</span><br><span class="line">  loadBalanceVirtualNodes = 10</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application = "seata-server"</span><br><span class="line">    serverAddr = "127.0.0.1:8848"</span><br><span class="line">    group = "SEATA_GROUP"</span><br><span class="line">    namespace = "seata"</span><br><span class="line">    cluster = "seata"</span><br><span class="line">    username = "nacos"</span><br><span class="line">    password = "nacos"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> file、nacos 、apollo、zk、consul、etcd3</span></span><br><span class="line">  type = "nacos"</span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = "xxx.xxx.xxx.xxx:8848"</span><br><span class="line">    namespace = "seata"</span><br><span class="line">    group = "SEATA_GROUP"</span><br><span class="line">    username = "nacos"</span><br><span class="line">    password = "nacos"</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>127.0.0.1修改成nacos注册中心地址，执行<code>bin</code>目录下的<code>seata-server.sh</code>启动seata服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ./seata-server.sh -p 8091 -h 127.0.0.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><p>整个seata目录内容如下：</p><img src="/images/image-20210420214024507.png" alt="image-20210420214024507" style="zoom:50%;"><h3 id="3demo测试"><a class="markdownIt-Anchor" href="#3demo测试"></a> 3.demo测试</h3><blockquote><ol><li><p>下载<code>seata-demo</code>测试用例:<a href="https://github.com/luxiaowan/cc-springboot-family.git" target="_blank" rel="noopener">https://github.com/luxiaowan/cc-springboot-family.git</a></p><p>cc-nacos-client1<br>cc-nacos-client2<br>cc-nacos-client3<br>cc-spring-boot-seata</p></li></ol></blockquote><blockquote><ol start="2"><li>创建<code>db_account</code>、<code>db_order</code>、<code>db_storage</code>脚本如下</li></ol></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">schema</span> db_account;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db_account.account_tbl (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">user_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="literal">null</span>,</span><br><span class="line">money <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span> <span class="literal">null</span></span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db_account.undo_log (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">branch_id <span class="built_in">bigint</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">xid <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">context</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">rollback_info longblob <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_status <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_created datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_modified datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">ext <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">constraint</span> ux_undo_log <span class="keyword">unique</span> (xid, branch_id)</span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> db_account.account_tbl (<span class="keyword">id</span>, user_id, money) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'1001'</span>, <span class="number">10000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> db_account.account_tbl (<span class="keyword">id</span>, user_id, money) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'1002'</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">schema</span> db_order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db_order.order_tbl (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">user_id <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="literal">null</span>,</span><br><span class="line">commodity_code <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">count</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span> <span class="literal">null</span>,</span><br><span class="line">money <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span> <span class="literal">null</span></span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db_order.undo_log (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">branch_id <span class="built_in">bigint</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">xid <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">context</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">rollback_info longblob <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_status <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_created datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_modified datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">ext <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">constraint</span> ux_undo_log <span class="keyword">unique</span> (xid, branch_id)</span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">schema</span> db_storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db_storage.storage_tbl (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">commodity_code <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">count</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span> <span class="literal">null</span>,</span><br><span class="line">price <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">default</span> <span class="number">0.00</span> <span class="literal">null</span> <span class="keyword">comment</span> <span class="string">'单价'</span>,</span><br><span class="line"><span class="keyword">constraint</span> commodity_code <span class="keyword">unique</span> (commodity_code)</span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> db_storage.undo_log (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">branch_id <span class="built_in">bigint</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">xid <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">context</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">rollback_info longblob <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_status <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_created datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_modified datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">constraint</span> ux_undo_log <span class="keyword">unique</span> (xid, branch_id)</span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> db_storage.storage_tbl (<span class="keyword">id</span>, commodity_code, <span class="keyword">count</span>, price) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'2001'</span>, <span class="number">900</span>, <span class="number">2.00</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">schema</span> seata;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> seata.undo_log (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">branch_id <span class="built_in">bigint</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">xid <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">context</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">rollback_info longblob <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_status <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_created datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_modified datetime <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">constraint</span> ux_undo_log <span class="keyword">unique</span> (xid, branch_id)</span><br><span class="line">) <span class="keyword">charset</span>=utf8;</span><br></pre></td></tr></table></figure><blockquote><ol start="3"><li>启动各服务,只要在开始全局事务的地方加上注解<code>@GlobalTransactional</code>就开启AT模式的分布式事务</li></ol></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;1nacos服务&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1nacos服务&quot;&gt;&lt;/a&gt; 1.nacos服务&lt;/h3&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;下载 &lt;a href=&quot;https://github.com/ali
      
    
    </summary>
    
    
      <category term="分布式" scheme="http://chuanyichuan.github.io/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="分布式事务" scheme="http://chuanyichuan.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
      <category term="Seata" scheme="http://chuanyichuan.github.io/tags/Seata/"/>
    
  </entry>
  
</feed>
